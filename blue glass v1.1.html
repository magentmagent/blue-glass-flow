<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tsukihime R Flowchart - v9.4 (Bug Fixed)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html-to-image/1.11.11/html-to-image.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        /* --- 1. í…Œë§ˆ ì„¤ì • --- */
        :root {
            --bg-deep: #050510;
            --bg-panel: rgba(15, 20, 35, 0.98);
            --bg-card: rgba(30, 35, 50, 0.6);
            --grid-line: rgba(60, 100, 255, 0.05);
            --node-bg: rgba(20, 25, 40, 0.95);
            --node-border: rgba(100, 200, 255, 0.3);
            --text-main: #e0e4ff;
            --text-dim: #8899aa;
            --accent-cyan: #00f0ff;
            --accent-hover: rgba(0, 240, 255, 0.1);
            --color-choice: #ffcc00;
            --color-dead: #ff3333;
            --separator-color: rgba(255, 255, 255, 0.2);
            --select-box-bg: rgba(0, 240, 255, 0.1);
            --select-box-border: rgba(0, 240, 255, 0.6);
            
            --logic-if-bg: rgba(180, 100, 255, 0.15);
            --logic-if-text: #d0a0ff;
            --logic-if-border: #b060ff;
            
            --logic-set-bg: rgba(100, 255, 180, 0.15);
            --logic-set-text: #80ffb0;
            --logic-set-border: #50ff90;

            --font-ui: 'Noto Sans KR', sans-serif;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0; overflow: hidden;
            background-color: var(--bg-deep);
            background-image: 
                linear-gradient(var(--grid-line) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid-line) 1px, transparent 1px);
            background-size: 40px 40px;
            font-family: var(--font-ui);
            color: var(--text-main);
            width: 100vw; height: 100dvh;
            overscroll-behavior: none;
            user-select: none;
        }

        /* --- 2. íˆ´ë°” ë° ë ˆì´ì•„ì›ƒ --- */
        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; flex-direction: column; }
        .screen.active { display: flex; }

        /* í™ˆ í™”ë©´ */
        #screen-home { background-image: radial-gradient(circle at center, #1a1f35 0%, #050510 100%); padding: 40px; overflow-y: auto; }
        .home-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; padding-bottom: 20px; border-bottom: 1px solid var(--node-border); flex-wrap: wrap; gap: 20px; }
        .home-title { font-size: 24px; font-weight: bold; color: var(--accent-cyan); letter-spacing: 2px; }
        .home-controls { display: flex; gap: 10px; }
        .folder-tabs { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; }
        .folder-tab { padding: 8px 16px; border: 1px solid var(--node-border); cursor: pointer; color: var(--text-dim); transition: 0.2s; border-radius: 20px; white-space: nowrap; }
        .folder-tab.active { background: var(--accent-hover); border-color: var(--accent-cyan); color: var(--accent-cyan); }
        .project-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
        .project-card { background: var(--bg-card); border: 1px solid var(--node-border); padding: 20px; border-radius: 8px; cursor: pointer; transition: 0.2s; display: flex; flex-direction: column; gap: 10px; position: relative; }
        .project-card:hover { transform: translateY(-5px); border-color: var(--accent-cyan); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .card-title { font-size: 16px; font-weight: bold; color: #fff; }
        .card-info { font-size: 12px; color: var(--text-dim); }
        .card-actions { position: absolute; top: 10px; right: 10px; opacity: 0; transition: 0.2s; display: flex; gap: 5px; }
        .project-card:hover .card-actions { opacity: 1; }
        .card-btn { padding: 4px 8px; font-size: 10px; background: #333; border: 1px solid #555; color: #fff; cursor: pointer; }
        .card-btn:hover { background: #500; border-color: var(--color-dead); }

        /* ì—ë””í„° í™”ë©´ */
        #editor-header { position: fixed; top: 0; left: 0; width: 100%; height: 40px; background: rgba(5, 5, 16, 0.9); border-bottom: 1px solid var(--node-border); display: flex; align-items: center; padding: 0 15px; z-index: 200; justify-content: space-between; }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .project-name-display { font-size: 14px; font-weight: bold; color: var(--text-main); }
        .header-btn { background: none; border: none; color: var(--text-dim); cursor: pointer; font-size: 18px; }
        .header-btn:hover { color: var(--accent-cyan); }

        #toolbar { 
            position: fixed; 
            top: 50px; 
            left: 20px; 
            width: 240px; 
            
            /* [í•µì‹¬ ìˆ˜ì •] ë†’ì´ ì œí•œ ë° ìŠ¤í¬ë¡¤ ì„¤ì • */
            max-height: calc(100vh - 70px); /* í™”ë©´ ì „ì²´ ë†’ì´ - (ìƒë‹¨ í—¤ë” + ì—¬ë°±) */
            overflow-y: auto; /* ë‚´ìš©ì´ ë„˜ì¹˜ë©´ ì„¸ë¡œ ìŠ¤í¬ë¡¤ ìƒì„± */
            overflow-x: hidden; /* ê°€ë¡œ ìŠ¤í¬ë¡¤ ë°©ì§€ */
            
            background: var(--bg-panel); 
            border: 1px solid var(--node-border); 
            backdrop-filter: blur(10px); 
            z-index: 100; 
            display: flex; 
            flex-direction: column; 
            gap: 6px; /* ê°„ê²©ì„ 8px -> 6pxë¡œ ì‚´ì§ ì¤„ì—¬ ë” ë§ì´ ë³´ì´ê²Œ í•¨ */
            padding: 15px; 
            border-left: 3px solid var(--accent-cyan); 
            box-shadow: 0 5px 20px rgba(0,0,0,0.5); 
            transition: transform 0.3s ease; 
        }

        /* íˆ´ë°” ë‚´ë¶€ ìŠ¤í¬ë¡¤ë°” ë””ìì¸ (ì–‡ê³  ì˜ˆì˜ê²Œ) */
        #toolbar::-webkit-scrollbar {
            width: 4px; /* ìŠ¤í¬ë¡¤ë°” ë„ˆë¹„ */
        }
        #toolbar::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.2); 
            margin: 5px 0; /* ìœ„ì•„ë˜ ì—¬ë°± */
        }
        #toolbar::-webkit-scrollbar-thumb {
            background: rgba(0, 240, 255, 0.3); /* ìŠ¤í¬ë¡¤ë°” ìƒ‰ìƒ */
            border-radius: 2px;
        }
        #toolbar::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 240, 255, 0.6); 
        }

        #toolbar.hidden { transform: translateX(-300px); }
        
        #toolbar-toggle { 
            position: fixed; top: 50px; left: 20px; width: 30px; height: 30px; 
            background: var(--bg-panel); border: 1px solid var(--accent-cyan); 
            color: var(--accent-cyan); display: none; align-items: center; 
            justify-content: center; z-index: 99; cursor: pointer; 
        }
        #toolbar.hidden + #toolbar-toggle { display: flex; }

        /* ëª¨ë°”ì¼ ëŒ€ì‘ (ê¸°ì¡´ ìœ ì§€í•˜ë˜ ë†’ì´ ê´€ë ¨ ì†ì„± ì¶©ëŒ ë°©ì§€) */
        @media (max-width: 768px) { 
            #toolbar { 
                top: auto; bottom: 0; left: 0; width: 100%; 
                height: 60px; /* ëª¨ë°”ì¼ì€ ê³ ì • ë†’ì´ */
                max-height: none; /* ëª¨ë°”ì¼ì—ì„œ ë†’ì´ ì œí•œ í•´ì œ */
                flex-direction: row; 
                padding: 8px 15px; 
                border-left: none; border-top: 2px solid var(--accent-cyan); 
                overflow-y: hidden; /* ì„¸ë¡œ ìŠ¤í¬ë¡¤ ë” */
                overflow-x: auto; /* ê°€ë¡œ ìŠ¤í¬ë¡¤ ì¼¬ */
                white-space: nowrap; 
                transform: none !important; 
            } 
            #toolbar-toggle { display: none !important; } 
        }
        
        .btn { flex: 0 0 auto; background: rgba(255,255,255,0.08); border: 1px solid var(--node-border); color: var(--text-main); padding: 8px 14px; cursor: pointer; font-size: 13px; border-radius: 4px; display: inline-flex; align-items: center; justify-content: center; }
        .btn:active, .btn:hover { background: rgba(0, 240, 255, 0.2); border-color: var(--accent-cyan); }
        .btn-danger { border-color: rgba(255,50,50,0.5); color: #ffaaaa; }
        .btn.active { background: var(--accent-cyan); color: #000; font-weight: bold; box-shadow: 0 0 10px var(--accent-cyan); }
        .btn-row { display: flex; gap: 5px; width: 100%; } .btn-row .btn { flex: 1; }
        .divider { width: 100%; height: 1px; background: var(--node-border); margin: 5px 0; }
        @media (max-width: 768px) { .divider { width: 1px; height: 20px; margin: 0 5px; } }

        /* íŒ¨ë„ & ëª¨ë‹¬ */
        #detail-panel { position: fixed; top: 40px; right: -320px; width: 300px; height: calc(100dvh - 40px); background: var(--bg-panel); z-index: 200; transition: right 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); display: flex; flex-direction: column; box-shadow: -5px 0 30px rgba(0,0,0,0.9); border-left: 1px solid var(--node-border); }
        #detail-panel.active { right: 0; }
        @media (max-width: 768px) { #detail-panel { width: 100%; right: -100%; } }
        .panel-top { padding: 15px; border-bottom: 1px solid var(--node-border); display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.3); }
        .panel-title { font-weight: bold; color: var(--accent-cyan); }
        .panel-content { padding: 20px; overflow-y: auto; flex: 1; display: flex; flex-direction: column; gap: 15px; }
        .input-group { display: none; } .input-group.visible { display: block; }
        label { font-size: 12px; color: var(--text-dim); margin-bottom: 5px; display: block;}
        input, textarea, select { width: 100%; background: rgba(0,0,0,0.4); border: 1px solid var(--node-border); color: var(--text-main); padding: 12px; font-size: 14px; border-radius: 4px; }
        textarea { height: 100px; resize: none; line-height: 1.5; }
        .logic-input { border-left: 3px solid; } #input-req { border-left-color: var(--logic-if-border); } #input-act { border-left-color: var(--logic-set-border); }

        /* ê³µí†µ ëª¨ë‹¬ */
        #confirm-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); z-index: 9999; display: none; align-items: center; justify-content: center; }
        .modal-content { background: var(--node-bg); border: 1px solid var(--accent-cyan); padding: 20px; width: 300px; box-shadow: 0 0 30px rgba(0, 0, 0, 0.8); text-align: center; }
        .modal-msg { margin-bottom: 20px; line-height: 1.5; font-size: 14px; }
        .modal-btns { display: flex; gap: 10px; justify-content: center; }
        .modal-btns button { flex: 1; }

        /* ê²€ìƒ‰ì°½ */
        #search-bar { display: none; margin-bottom: 10px; width: 100%; }
        .search-wrapper { display: flex; gap: 5px; align-items: center; }
        #search-input { flex: 1; padding: 6px; font-size: 12px; background: #000; border: 1px solid var(--accent-cyan); color: #fff; }
        #search-count { font-size: 10px; color: var(--text-dim); min-width: 30px; text-align: center; }
        .search-nav-btn { padding: 4px 8px; font-size: 10px; cursor: pointer; background: #223; border: 1px solid #445; color: #fff; }

        /* ìº”ë²„ìŠ¤ & ë¯¸ë‹ˆë§µ */
        #canvas-area { position: relative; width: 100vw; height: 100%; overflow: hidden; cursor: grab; touch-action: none; margin-top: 40px; }
        #canvas-area.select-mode { cursor: crosshair; }
        #world-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transform-origin: 0 0; }
        #svg-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; overflow: visible !important; }
        #selection-box { 
    position: fixed; /* absolute -> fixed ë¡œ ë³€ê²½ */
    background: rgba(0, 240, 255, 0.15); /* ìƒ‰ìƒ ë†ë„ ì•½ê°„ ì¦ê°€ */
    border: 1px dashed rgba(0, 240, 255, 0.8); 
    display: none; 
    pointer-events: none; 
    z-index: 99999; /* ìµœìƒë‹¨ ë³´ì¥ */
    box-sizing: border-box;
    left: 0; top: 0; /* ì´ˆê¸° ìœ„ì¹˜ ê³ ì • */
}
        #minimap { position: fixed; bottom: 20px; right: 20px; width: 200px; height: 150px; background: rgba(0,0,0,0.8); border: 1px solid var(--node-border); z-index: 90; overflow: hidden; cursor: crosshair; box-shadow: 0 0 15px rgba(0,0,0,0.5); display: none; }
        #minimap.active { display: block; }
        #minimap-canvas { width: 100%; height: 100%; }
        #minimap-viewport { position: absolute; border: 1px solid var(--accent-cyan); background: rgba(0, 240, 255, 0.1); pointer-events: none; }

        path.link { fill: none; stroke-width: 2px; transition: stroke 0.2s; shape-rendering: crispEdges; cursor: pointer; pointer-events: none; }
        path.link.selected { stroke: #ff3333 !important; stroke-width: 3px; filter: drop-shadow(0 0 5px red); }
        
        /* [ìˆ˜ì •ë¨] ì—°ê²°ì„  íˆíŠ¸ë°•ìŠ¤ ê°œì„ : transparent ëŒ€ì‹  rgba(0,0,0,0) ì‚¬ìš© ë° pointer-events ê°•í™” */
        path.link-hit { 
            fill: none; 
            stroke: rgba(0,0,0,0); 
            stroke-width: 20px; 
            cursor: pointer; 
            pointer-events: stroke; 
        }

        .node { position: absolute; width: 160px; min-height: 90px; padding: 8px; background: var(--node-bg); border: 1px solid var(--node-border); border-radius: 2px; color: var(--text-main); z-index: 10; box-shadow: 0 4px 10px rgba(0,0,0,0.8); user-select: none; display: flex; flex-direction: column; gap: 4px; transition: left 0.2s ease-out, top 0.2s ease-out, border-color 0.2s; }
        .node.dragging { transition: none; z-index: 100; opacity: 0.8; box-shadow: 0 0 15px var(--accent-cyan); }
        .node.selected { border: 1px solid var(--accent-cyan); box-shadow: 0 0 0 2px rgba(0, 240, 255, 0.3), 0 0 20px rgba(0, 240, 255, 0.1); z-index: 20; }
        .node-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2px; }
        .node-title { font-weight: bold; font-size: 12px; text-shadow: 0 2px 4px rgba(0,0,0,0.8); }
        .logic-tag { font-size: 10px; padding: 2px 4px; border-radius: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 2px; }
        .logic-req { background: var(--logic-if-bg); color: var(--logic-if-text); border: 1px solid var(--logic-if-border); }
        .logic-act { background: var(--logic-set-bg); color: var(--logic-set-text); border: 1px solid var(--logic-set-border); margin-top: auto; }
        .node-desc {
            font-size: 10px;
            color: var(--text-dim);
            
            /* 1. ë§ì¤„ì„í‘œ(...) ì²˜ë¦¬ë¥¼ ìœ„í•œ í•„ìˆ˜ ì†ì„± */
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            
            /* 2. [í•µì‹¬] ë†’ì´ ë¬¼ë¦¬ì  ì œí•œ (ì´ë¯¸ì§€ ì €ì¥ ì‹œ í’€ë¦¼ ë°©ì§€) */
            line-height: 1.4;       /* ì¤„ ê°„ê²© ê³ ì • */
            max-height: 4.2em;      /* 1.4 * 3ì¤„ = 4.2em (ì´ ì´ìƒì€ ë¬´ì¡°ê±´ ì˜ë¦¼) */
            
            /* 3. ë ˆì´ì•„ì›ƒ ê¹¨ì§ ë°©ì§€ */
            word-break: break-all;  /* ê¸´ ì˜ë‹¨ì–´ë„ ê°•ì œë¡œ ì¤„ë°”ê¿ˆ */
            pointer-events: none; 
            flex: 1; 
            margin-top: 2px;
        }
        .node[data-type="choice"] { border-left: 3px solid var(--color-choice); }
        .node[data-type="dead"] { border-left: 3px solid var(--color-dead); }
        .node[data-type="normal"] { border-left: 3px solid var(--accent-cyan); }

        .node-actions {
            position: absolute; top: -35px; left: 50%; transform: translateX(-50%);
            background: var(--bg-panel); border: 1px solid var(--accent-cyan); border-radius: 20px;
            display: none; gap: 5px; padding: 3px 8px; z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
        .node.selected .node-actions { display: flex; animation: popUp 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popUp { from { opacity: 0; transform: translate(-50%, 10px); } to { opacity: 1; transform: translate(-50%, 0); } }

        .action-btn {
            background: none; border: none; color: var(--text-main); font-size: 14px; cursor: pointer;
            width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
        }
        .action-btn:hover { background: rgba(0, 240, 255, 0.2); color: var(--accent-cyan); }
        .action-btn.delete:hover { background: rgba(255, 50, 50, 0.2); color: #ff5555; }

        .node.waiting-target {
            box-shadow: 0 0 15px var(--color-choice); border-color: var(--color-choice);
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 204, 0, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(255, 204, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 204, 0, 0); }
        }

        .connection-actions {
            position: absolute; transform: translate(-50%, -50%);
            background: var(--bg-panel); border: 1px solid var(--accent-cyan); border-radius: 20px;
            display: flex; gap: 5px; padding: 5px 10px; z-index: 200;
            box-shadow: 0 2px 10px rgba(0,0,0,0.8); pointer-events: auto;
            animation: popIn 0.2s ease-out;
        }
        @keyframes popIn { from { opacity: 0; transform: translate(-50%, -40%); } to { opacity: 1; transform: translate(-50%, -50%); } }
        .action-btn.delete { color: #ff5555; }
        .action-btn.delete:hover { background: rgba(255, 50, 50, 0.2); }

        #file-explorer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index: 3000; display: none; align-items: center; justify-content: center; }
        .explorer-window { background: var(--node-bg); border: 1px solid var(--accent-cyan); width: 95%; max-width: 700px; height: 80%; display: flex; flex-direction: column; box-shadow: 0 0 30px rgba(0,240,255,0.2); }
        .explorer-header { padding: 15px; border-bottom: 1px solid var(--node-border); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .explorer-header span { white-space: nowrap; font-size: 16px; font-weight: bold; color: var(--accent-cyan); }
        .explorer-controls { display: flex; gap: 5px; flex-wrap: wrap; }
        .explorer-body { flex: 1; overflow-y: auto; padding: 15px; }
        .file-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid var(--node-border); cursor: pointer; transition: 0.2s; }
        .file-item:hover { background: rgba(0,240,255,0.1); }
        .file-name { font-size: 14px; color: var(--text-main); font-weight: bold; }
        .file-date { font-size: 11px; color: var(--text-dim); margin-top: 3px; }
        .file-actions { display: flex; gap: 5px; }
        .rename-input {
    background: rgba(0, 0, 0, 0.5);
    border: 1px solid var(--accent-cyan);
    color: #fff;
    font-size: 16px;
    font-weight: bold;
    padding: 2px 5px;
    width: 100%;
    border-radius: 4px;
    outline: none;
}

        #toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 20px; font-size: 12px; pointer-events: none; opacity: 0; transition: opacity 0.5s; z-index: 500; }
    
        #screen-play { 
    position: fixed; /* absolute -> fixed ë³€ê²½ */
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0, 0, 0, 1); /* ì™„ì „ ê²€ì€ ë°°ê²½ */
    z-index: 99999; /* ìµœìƒë‹¨ */
    display: none;
    flex-direction: column;
}
        .play-container { width: 100%; height: 100%; display: flex; flex-direction: column; padding: 40px; max-width: 1000px; margin: 0 auto; position: relative; }
        .play-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; border-bottom: 1px solid var(--node-border); padding-bottom: 20px; }
        .play-title { font-size: 20px; font-weight: bold; color: var(--color-choice); letter-spacing: 2px; }
        .story-box { background: rgba(20, 25, 40, 0.8); border: 1px solid var(--accent-cyan); padding: 30px; border-radius: 4px; min-height: 200px; margin-bottom: 30px; box-shadow: 0 0 20px rgba(0, 240, 255, 0.1); position: relative; }
        .story-text { font-size: 18px; line-height: 1.6; white-space: pre-wrap; }
        .choice-container { display: flex; flex-direction: column; gap: 15px; align-items: center; }
        .play-btn { width: 100%; max-width: 600px; padding: 15px 20px; background: rgba(0, 0, 0, 0.5); border: 1px solid var(--node-border); color: var(--text-main); cursor: pointer; font-size: 16px; transition: 0.2s; text-align: left; position: relative; overflow: hidden; }
        .play-btn:hover { background: rgba(0, 240, 255, 0.1); border-color: var(--accent-cyan); transform: translateX(10px); }
        .play-btn::before { content: 'â—†'; color: var(--accent-cyan); margin-right: 10px; }
        .play-btn.dead-end { border-color: var(--color-dead); color: #ffaaaa; }
        .play-btn.dead-end::before { content: 'â˜ ï¸'; color: var(--color-dead); }
        .debug-panel { position: absolute; top: 100px; right: -20px; width: 200px; background: rgba(0, 0, 0, 0.8); border: 1px solid var(--separator-color); padding: 10px; font-size: 12px; font-family: monospace; }
        .debug-title { font-weight: bold; color: var(--text-dim); border-bottom: 1px solid #333; margin-bottom: 5px; padding-bottom: 5px; }
        .debug-content { color: var(--accent-cyan); line-height: 1.5; }
        @media (max-width: 1200px) { .debug-panel { position: static; width: 100%; margin-top: 20px; } }
        .group-box {
            position: absolute;
            border: 2px dashed; /* ìƒ‰ìƒì€ JSì¸ë¼ì¸ ìŠ¤íƒ€ì¼ë¡œ ì œì–´ */
            background: rgba(255, 255, 255, 0.02);
            border-radius: 8px;
            z-index: 5; 
            display: flex;
            flex-direction: column;
            transition: background 0.2s;
        }
        .group-box:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        .group-box.selected {
            border-style: solid;
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 0 15px rgba(0,0,0,0.3);
        }

        .group-header {
            padding: 5px 10px;
            font-size: 14px;
            font-weight: bold;
            color: #fff; /* í…ìŠ¤íŠ¸ëŠ” í°ìƒ‰ ê³ ì • (ë°°ê²½ìƒ‰ì´ ì–´ë‘ìš¸ ê²ƒì´ë¯€ë¡œ) */
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
            cursor: grab;
            user-select: none;
            /* ë°°ê²½ìƒ‰ì€ JSì—ì„œ ê·¸ë£¹ ìƒ‰ìƒì˜ íˆ¬ëª…ë„ ì¡°ì ˆ ë²„ì „ìœ¼ë¡œ ì ìš©ë¨ */
            border-radius: 6px 6px 0 0;
            border-bottom: 1px solid rgba(0,0,0,0.2);
        }
        .group-box.selected .group-header {
            /* color: var(--accent-cyan);
            background: rgba(0, 240, 255, 0.1); */
        }

        /* ìš°í•˜ë‹¨ í¬ê¸° ì¡°ì ˆ í•¸ë“¤ */
        .resize-handle {
            position: absolute;
            bottom: 0; right: 0;
            width: 20px; height: 20px;
            cursor: nwse-resize;
            background: linear-gradient(135deg, transparent 50%, var(--text-dim) 50%);
            opacity: 0.3;
            border-radius: 0 0 6px 0;
        }
        .group-box:hover .resize-handle { opacity: 0.7; }
        .group-box.selected .resize-handle { background: linear-gradient(135deg, transparent 50%, var(--accent-cyan) 50%); opacity: 1; }

        .world-zoomed-out .node-desc,
.world-zoomed-out .logic-tag,
.world-zoomed-out .node-actions {
    display: none !important;
}

.world-zoomed-out .node {
    box-shadow: none !important;
    /* [ìˆ˜ì •] auto ëŒ€ì‹  ì •í™•í•œ í”½ì…€ê°’ ì§€ì • (ê³„ì‚° ì¼ì¹˜ë¥¼ ìœ„í•´) */
    height: 34px !important;     
    min-height: 34px !important;
    overflow: hidden !important; /* ë‚´ìš© ë„˜ì¹¨ ë°©ì§€ */
}

.world-zoomed-out .node-header {
    margin-bottom: 0;
}

/* =========================================
   [ìˆ˜ì •ë¨] UI ì»´í¬ë„ŒíŠ¸ ìŠ¤íƒ€ì¼ (ë“œë¡­ë‹¤ìš´ & ìë™ì™„ì„±)
   ========================================= */

/* 1. ì…ë ¥ ìš”ì†Œ ê³µí†µ ìŠ¤íƒ€ì¼ */
input, textarea, select {
    width: 100%;
    background: rgba(0, 0, 0, 0.4);
    border: 1px solid var(--node-border);
    color: var(--text-main);
    padding: 12px;
    font-size: 14px;
    border-radius: 4px;
    transition: border-color 0.2s, background-color 0.2s;
    box-sizing: border-box; /* ì¤‘ìš”: íŒ¨ë”© í¬í•¨ í¬ê¸° ê³„ì‚° */
}

/* 2. ì»¤ìŠ¤í…€ ë“œë¡­ë‹¤ìš´ (ë¸Œë¼ìš°ì € ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì œê±°) */
select {
    -webkit-appearance: none; /* Chrome, Safari ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì œê±° */
    -moz-appearance: none;    /* Firefox ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì œê±° */
    appearance: none;
    cursor: pointer;
    
    /* ì»¤ìŠ¤í…€ í™”ì‚´í‘œ ì•„ì´ì½˜ */
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2300f0ff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 10px center;
    background-size: 16px;
    padding-right: 35px;
}

select:hover {
    border-color: var(--accent-cyan);
    background-color: rgba(0, 240, 255, 0.05);
}

select:focus {
    outline: none;
    border-color: var(--accent-cyan);
    box-shadow: 0 0 0 2px rgba(0, 240, 255, 0.2);
    background-color: rgba(0, 0, 0, 0.8);
}

option {
    background-color: #1a1f35; /* ë‹¤í¬ í…Œë§ˆ ë°°ê²½ */
    color: #fff;
}

/* 3. ì»¤ìŠ¤í…€ ìë™ì™„ì„± ëª©ë¡ ìŠ¤íƒ€ì¼ */
.logic-row {
    position: relative; /* [ì¤‘ìš”] ìì‹ì¸ ulì˜ ìœ„ì¹˜ ê¸°ì¤€ì  */
    display: flex;
    gap: 5px; /* ìš”ì†Œ ê°„ ê°„ê²© */
}

.autocomplete-list {
    position: absolute;
    top: 100%; /* ì…ë ¥ì°½ ë°”ë¡œ ì•„ë˜ */
    left: 0;
    
    /* [ìˆ˜ì •ë¨] ë„ˆë¹„ë¥¼ ë¶€ëª¨(ì…ë ¥ì°½ ë˜í¼)ì— ê½‰ ì°¨ê²Œ ë³€ê²½ */
    width: 100%; 
    min-width: 150px; /* ë„ˆë¬´ ì¢ì•„ì§€ì§€ ì•Šë„ë¡ ìµœì†Œ í­ ë³´ì¥ */
    
    max-height: 150px;
    overflow-y: auto;
    background: var(--bg-panel);
    border: 1px solid var(--accent-cyan);
    border-radius: 0 0 4px 4px;
    z-index: 9999; 
    list-style: none;
    padding: 0;
    margin: 2px 0 0 0;
    display: none; 
    box-shadow: 0 4px 15px rgba(0,0,0,0.8);
}

.autocomplete-list.active {
    display: block;
}

.autocomplete-item {
    padding: 8px 10px;
    font-size: 12px;
    color: var(--text-main);
    cursor: pointer;
    border-bottom: 1px solid var(--node-border);
}

.autocomplete-item:last-child {
    border-bottom: none;
}

.autocomplete-item:hover, .autocomplete-item.focused {
    background: rgba(0, 240, 255, 0.2);
    color: #fff;
}

.var-type-tag {
    font-size: 10px;
    color: var(--text-dim);
    float: right;
    opacity: 0.7;
}

/* ë¡œì§ ë¹Œë” í–‰ ìŠ¤íƒ€ì¼ */
.logic-row-item {
    display: flex;
    gap: 5px;
    align-items: center;
    background: rgba(255, 255, 255, 0.05);
    padding: 5px;
    border-radius: 4px;
    position: relative; /* ìë™ì™„ì„± ëª©ë¡ ìœ„ì¹˜ ê¸°ì¤€ */
}

.logic-row-item input, 
.logic-row-item select {
    padding: 6px; 
    font-size: 12px;
    height: 30px;
}

.btn-del-logic {
    background: rgba(255, 50, 50, 0.2);
    color: #ffaaaa;
    border: 1px solid rgba(255, 50, 50, 0.5);
    width: 24px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    flex-shrink: 0;
}
.btn-del-logic:hover {
    background: rgba(255, 50, 50, 0.4);
}

/* ì ‘íŒ ìƒíƒœì˜ ê·¸ë£¹ ìŠ¤íƒ€ì¼ */
.group-box.collapsed {
    height: 40px !important; /* í—¤ë” ë†’ì´ë§Œí¼ë§Œ ë‚¨ê¹€ */
    border-style: solid;
    background: rgba(255, 255, 255, 0.1);
    overflow: hidden;
}

.group-box.collapsed .resize-handle {
    display: none; /* ì ‘í˜”ì„ ë• í¬ê¸° ì¡°ì ˆ ë¶ˆê°€ */
}

/* ì ‘í˜ ìƒíƒœ ì•„ì´ì½˜ */
.group-toggle-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 20px;
    height: 20px;
    margin-right: 5px;
    cursor: pointer;
    border-radius: 3px;
    transition: background 0.2s;
}

.group-toggle-icon:hover {
    background: rgba(255, 255, 255, 0.2); /* í˜¸ë²„ íš¨ê³¼ ì¶”ê°€ */
}

/* --- [ì‹ ê·œ] ìºë¦­í„° ê´€ë¦¬ ë° ëŒ€ì‚¬ ë¹Œë” --- */
.char-row { display: flex; gap: 5px; margin-bottom: 5px; align-items: center; }
.color-picker { width: 30px; height: 30px; padding: 0; border: none; background: none; cursor: pointer; }

/* ëŒ€ì‚¬ ë¹Œë” (ë…¸ë“œ ì†ì„±ì°½ ë‚´ë¶€) */
.dialogue-list { display: flex; flex-direction: column; gap: 8px; max-height: 300px; overflow-y: auto; margin-bottom: 10px; padding-right: 5px; }
.dialogue-row { display: flex; gap: 5px; background: rgba(255,255,255,0.05); padding: 5px; border-radius: 4px; align-items: flex-start; }
.dialogue-row select { width: 80px; font-size: 11px; padding: 5px; height: 32px; }
.dialogue-row textarea { 
    flex: 1; 
    min-height: 32px; 
    font-size: 12px; 
    resize: none; /* ì‚¬ìš©ì ì„ì˜ ì¡°ì ˆ ë°©ì§€ */
    overflow: hidden; /* ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¹€ */
    line-height: 1.4;
    padding: 6px;
}

/* --- [ì‹ ê·œ] ë…¸ë“œ ì¢Œì¸¡ ìºë¦­í„° ìƒ‰ìƒ ë  --- */
.node-char-strip {
    position: absolute;
    left: 0; top: 0; bottom: 0;
    width: 4px; /* ë  ë„ˆë¹„ */
    display: flex;
    flex-direction: column;
    z-index: 5;
    pointer-events: none;
}
.char-color-indicator {
    flex: 1; /* ê· ë“± ë¶„í•  */
    width: 100%;
}
/* ì¤Œ ì•„ì›ƒ ì‹œ ìƒ‰ìƒ ë  ìˆ¨ê¸°ê¸° */
.world-zoomed-out .node-char-strip {
    display: none !important;
}

/* --- [ì‹ ê·œ] ë¹„ì£¼ì–¼ ë…¸ë²¨ í”Œë ˆì´ ëª¨ë“œ (VN ìŠ¤íƒ€ì¼) --- */
.vn-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; pointer-events: none; }
.vn-center-area { flex: 1; display: flex; align-items: center; justify-content: center; pointer-events: auto; } /* ì„ íƒì§€ í‘œì‹œ ì˜ì—­ */

.vn-textbox-container { 
    height: 25vh; 
    background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.6) 100%);
    padding: 20px 100px; 
    position: relative; 
    pointer-events: auto;
    border-top: 1px solid rgba(255,255,255,0.1);
    cursor: pointer; /* í´ë¦­í•´ì„œ ì§„í–‰ */
}

.vn-namebox {
    position: absolute; top: -20px; left: 100px;
    background: #333; color: #fff; padding: 5px 20px;
    font-weight: bold; font-size: 16px;
    border-radius: 4px; border: 1px solid rgba(255,255,255,0.2);
    box-shadow: 0 5px 15px rgba(0,0,0,0.5);
    min-width: 100px; text-align: center;
    display: none; /* ì´ë¦„ ì—†ì„ ë• ìˆ¨ê¹€ */
}

.vn-text { font-size: 18px; line-height: 1.6; color: #eee; text-shadow: 1px 1px 2px #000; white-space: pre-wrap; }

/* ì„ íƒì§€ ìŠ¤íƒ€ì¼ ì˜¤ë²„ë¼ì´ë“œ */
.vn-choice-btn {
    background: rgba(0, 0, 0, 0.7);
    border: 1px solid var(--accent-cyan);
    color: #fff; padding: 15px 40px; margin: 10px;
    font-size: 16px; cursor: pointer; min-width: 400px;
    transition: 0.2s; pointer-events: auto;
}
.vn-choice-btn:hover { background: rgba(0, 240, 255, 0.2); transform: scale(1.05); }

/* --- [ì‹ ê·œ] ì»¤ìŠ¤í…€ ìŠ¤í¬ë¡¤ë°” ë””ìì¸ --- */
::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}
::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.2); 
}
::-webkit-scrollbar-thumb {
    background: rgba(100, 200, 255, 0.2); 
    border-radius: 4px;
}
::-webkit-scrollbar-thumb:hover {
    background: rgba(0, 240, 255, 0.4); 
}
/* íŒ¨ë„ ë“± íŠ¹ì • ì˜ì—­ì€ ë” ì–‡ê²Œ */
#detail-panel ::-webkit-scrollbar, 
#toolbar ::-webkit-scrollbar, 
.dialogue-list ::-webkit-scrollbar {
    width: 4px;
}

.vn-scene-label {
    position: absolute;
    top: 20px; 
    left: 20px;
    color: var(--accent-cyan);
    font-size: 14px;
    font-weight: bold;
    background: rgba(0, 0, 0, 0.6);
    padding: 8px 15px;
    border-left: 3px solid var(--accent-cyan);
    backdrop-filter: blur(2px);
    pointer-events: none; /* í´ë¦­ ë°©í•´ ì•ˆ í•¨ */
    z-index: 20;
    display: flex;
    align-items: center;
    gap: 5px;
}

    </style>
</head>
<body>

    <div id="confirm-modal">
        <div class="modal-content">
            <div class="modal-msg" id="confirm-msg">ë©”ì‹œì§€</div>
            <div class="modal-btns" id="modal-actions"></div>
        </div>
    </div>

    <!-- SCREEN 1: í™ˆ -->
    <div id="screen-home" class="screen active">
        <div class="home-header">
            <div class="home-title">BLUE GLASS FLOW</div>
             <div id="cloud-controls" style="display: flex; align-items: center; gap: 10px;">
                <span id="user-display" style="font-size: 12px; color: var(--accent-cyan);"></span>
                <button class="btn" id="btn-login" onclick="googleLogin()" style="border-color: #4285F4; color: #fff; background: #4285F4;">G ë¡œê·¸ì¸</button>
                <button class="btn btn-danger" id="btn-logout" onclick="googleLogout()" style="display: none;">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
            <div class="home-controls">
                <button class="btn" onclick="createNewProject()">+ ìƒˆ í”„ë¡œì íŠ¸</button>
                <button class="btn" onclick="document.getElementById('json-input-home').click()">JSON ë¶ˆëŸ¬ì˜¤ê¸°</button>
                <input type="file" id="json-input-home" style="display: none;" accept=".json">
            </div>
        </div>
        <div class="folder-tabs" id="folder-list"></div>
        <div class="project-grid" id="project-list"></div>
    </div>

    <!-- SCREEN 2: ì—ë””í„° -->
    <div id="screen-editor" class="screen">
        <div id="editor-header">
            <div class="header-left">
                <button class="header-btn" onclick="tryGoHome()">ğŸ </button>
                <span class="project-name-display" id="current-project-name">Untitled</span>
            </div>
            <div style="display:flex; gap:10px">
                <button class="header-btn" onclick="toggleMinimap()">ğŸ—ºï¸</button>
                <button class="header-btn" onclick="toggleToolbar()">ğŸ› ï¸</button>
            </div>
        </div>

        <div id="toolbar">
            <div id="search-bar">
                <div class="search-wrapper">
                    <input type="text" id="search-input" placeholder="ê²€ìƒ‰..." onkeydown="if(event.key==='Enter') performSearch()">
                    <button class="search-nav-btn" onclick="searchPrev()">â—€</button>
                    <span id="search-count">0/0</span>
                    <button class="search-nav-btn" onclick="searchNext()">â–¶</button>
                </div>
            </div>
            <div class="btn-row">
                <button class="btn" onclick="undo()">â†©ï¸</button>
                <button class="btn" onclick="redo()">â†ªï¸</button>
                <button class="btn" id="btn-mode" onclick="toggleInteractMode()">ì´ë™</button>
            </div>
            <button class="btn" onclick="toggleSearch()">ğŸ” ê²€ìƒ‰</button>
            <button class="btn" onclick="saveCurrentProject()">ğŸ’¾ ì €ì¥</button>
            <button class="btn" onclick="startPlayMode()" style="border-color: var(--color-choice); color: var(--color-choice);">â–¶ í”Œë ˆì´</button>
            <div class="btn-row">
                <button class="btn" onclick="copySelected()">ğŸ“‹ ë³µì‚¬</button>
                <button class="btn" onclick="pasteNodes()">ğŸ“¥ ë¶™ì—¬</button>
            </div>
            <div class="divider"></div>
            <button class="btn" onclick="addNodeWithSelector()">âœš ë…¸ë“œ ì¶”ê°€</button>
            <button class="btn" onclick="openTypeManager()">ğŸ¨ íƒ€ì… ì„¤ì •</button>
            <button class="btn" onclick="openVariableManager()" style="border-color: #d0a0ff; color: #d0a0ff;">ğŸ“Š ë³€ìˆ˜ ê´€ë¦¬</button>
            <button class="btn" onclick="openCharManager()" style="border-color: #ff99cc; color: #ff99cc;">ğŸ‘¥ ìºë¦­í„°</button>
            <div class="divider"></div>
            <button class="btn" onclick="addGroup()">ğŸ”² ê·¸ë£¹</button>
            <button class="btn" onclick="openExportImageModal()" style="border-color: #88ff88; color: #ccffcc;">ğŸ“· ì´ë¯¸ì§€ ì €ì¥</button>
            <button class="btn" onclick="document.getElementById('export-modal').style.display='flex'" style="border-color: #ffcc00; color: #ffcc00;">ğŸ® ìŠ¤í¬ë¦½íŠ¸</button>
            <button class="btn" onclick="openFileExplorer()">ğŸ“‚ í”„ë¡œì íŠ¸ ê´€ë¦¬</button>
            <button class="btn btn-danger" onclick="tryDeleteSelection()">ğŸ—‘ï¸ ì‚­ì œ</button>
        </div>
        <div id="toolbar-toggle" onclick="toggleToolbar()">ğŸ› ï¸</div>

        <div id="canvas-area">
            <div id="world-container">
                <div id="separator-layer"></div>
                 <svg id="svg-layer">
        <path id="temp-link"></path> 
    </svg>
                <div id="nodes-layer"></div>
            </div>
        </div>
        <div id="minimap"><canvas id="minimap-canvas"></canvas><div id="minimap-viewport"></div></div>
        
        <div id="detail-panel">
            <datalist id="variable-list-suggestions"></datalist>
            <div class="panel-top">
                <div class="panel-title">ì†ì„± í¸ì§‘</div>
                <button class="btn" onclick="closePanel()" style="width: auto; padding: 5px 15px; background: var(--accent-blue);">ì™„ë£Œ</button>
            </div>
            <div class="panel-content">
    <div id="group-node" class="input-group">
    <label>ì¥ë©´ ì œëª© (ID)</label> <input type="text" id="input-title">
    <br><br>
    <label>íƒ€ì…</label>
    <select id="input-type">
        <option value="normal">ì¼ë°˜ ì¥ë©´</option>
        <option value="choice">ì„ íƒì§€</option>
        <option value="dead">ë°°ë“œ ì—”ë”©</option>
    </select>
    <br><br>
    
    <!-- í”Œë¡œìš°ì°¨íŠ¸ ìƒì— ë³´ì¼ í…ìŠ¤íŠ¸ -->
    <label style="color: var(--accent-cyan);">í”Œë¡œìš°ì°¨íŠ¸ ìš”ì•½ (Summary)</label> 
    <textarea id="input-summary" style="height: 50px;" placeholder="ì°¨íŠ¸ìƒì— í‘œì‹œë  ì§§ì€ ì„¤ëª…"></textarea>
    <br><br>

    <!-- ì‹¤ì œ ê²Œì„ ë‚´ìš© (ëŒ€ì‚¬) -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
        <label>ëŒ€ì‚¬ ë° ì§€ë¬¸ (Script)</label>
        <button class="btn" onclick="addDialogueRow()" style="font-size: 10px; padding: 2px 6px;">+ ì¤„ ì¶”ê°€</button>
    </div>
    <div id="dialogue-container" class="dialogue-list"></div>

    <hr style="border: 0; border-top: 1px solid var(--separator-color); margin: 15px 0;">

    <!-- ì¡°ê±´/ì—°ì‚° (ê¸°ì¡´ ìœ ì§€) -->
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <label style="color:#d0a0ff;">ì¡°ê±´ (IF)</label>
        <button class="btn" onclick="addLogicRow('req')" style="font-size: 10px;">+</button>
    </div>
    <div id="req-container" style="display: flex; flex-direction: column; gap: 5px; margin-bottom: 10px;"></div>
    <input type="hidden" id="input-req">

    <div style="display: flex; justify-content: space-between; align-items: center;">
        <label style="color:#80ffb0;">ì—°ì‚° (SET)</label>
        <button class="btn" onclick="addLogicRow('act')" style="font-size: 10px;">+</button>
    </div>
    <div id="act-container" style="display: flex; flex-direction: column; gap: 5px;"></div>
    <input type="hidden" id="input-act">
</div>

    <div id="group-group" class="input-group">
        <label>ê·¸ë£¹ ì´ë¦„</label> 
        <input type="text" id="input-group-title" oninput="window.updateGroupData()">
        <br><br>
        <label>ê·¸ë£¹ ìƒ‰ìƒ</label> 
        <div style="display: flex; gap: 10px;">
            <input type="color" id="input-group-color" style="width: 50px; height: 40px; padding: 0; border: none;" oninput="window.updateGroupData()" onchange="window.updateGroupData()">
            <button class="btn" onclick="window.resetGroupColor()" style="flex: 1;">ê¸°ë³¸ìƒ‰ ë³µì›</button>
        </div>
    </div>
</div>

    <!-- SCREEN 3: í”Œë ˆì´ í…ŒìŠ¤íŠ¸ ëª¨ë“œ -->
<div id="screen-play" class="screen" style="background-color: #000;"> <!-- ë°°ê²½ìƒ‰ì€ ì´ë¯¸ì§€ë¡œ ëŒ€ì²´ ê°€ëŠ¥ -->
    <!-- 1. ë°°ê²½ ë ˆì´ì–´ (ì¶”í›„ ì´ë¯¸ì§€ ê¸°ëŠ¥ í™•ì¥ ê°€ëŠ¥) -->
    <div id="play-bg" style="position: absolute; width: 100%; height: 100%; background: #111; z-index: 0;"></div>
    
    <!-- 2. ìºë¦­í„° ë ˆì´ì–´ (ìŠ¤íƒ ë”© CG ìœ„ì¹˜) -->
    <div id="play-chars" style="position: absolute; width: 100%; height: 100%; pointer-events: none; z-index: 1;"></div>

    <!-- 3. UI ë ˆì´ì–´ -->
    <div class="vn-layer" style="z-index: 10;">
        <div id="vn-scene-label" class="vn-scene-label"></div>
        <!-- ìƒë‹¨: ì¢…ë£Œ ë²„íŠ¼ -->
        <div style="padding: 20px; display: flex; justify-content: flex-end; pointer-events: auto;">
            <button class="btn btn-danger" onclick="closePlayMode()">ì¢…ë£Œ (ESC)</button>
        </div>

        <!-- ì¤‘ì•™: ì„ íƒì§€ ì˜ì—­ -->
        <div id="vn-choices" class="vn-center-area" style="flex-direction: column;"></div>

        <!-- í•˜ë‹¨: ëŒ€í™”ì°½ (í´ë¦­í•˜ì—¬ ì§„í–‰) -->
        <div id="vn-textbox" class="vn-textbox-container" onclick="advanceGameStep()">
            <div id="vn-namebox" class="vn-namebox"></div>
            <div id="vn-text" class="vn-text"></div>
            <div id="vn-indicator" style="position: absolute; bottom: 15px; right: 20px; color: var(--accent-cyan); animation: blink 1s infinite;">â–¼</div>
        </div>
    </div>
</div>

    

    <div id="file-explorer">
        <div class="explorer-window">
            <div class="explorer-header">
                <span>ì €ì¥ëœ í”„ë¡œì íŠ¸</span>
                <div class="explorer-controls">
                    <button class="btn" onclick="saveToBrowser()">+ í˜„ì¬ ì €ì¥</button>
                    <button class="btn" onclick="exportJSON()">JSON ë‚´ë³´ë‚´ê¸°</button>
                    <button class="btn" onclick="document.getElementById('json-input').click()">JSON ë¶ˆëŸ¬ì˜¤ê¸°</button>
                    <button class="btn btn-danger" onclick="closeFileExplorer()">ë‹«ê¸°</button>
                </div>
            </div>
            <div class="explorer-body" id="file-list"></div>
        </div>
    </div>

     <div id="export-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 4000; align-items: center; justify-content: center;">
        <div class="modal-content" style="width: 400px; text-align: left;">
            <h3 style="margin-top: 0; color: var(--accent-cyan); border-bottom: 1px solid #444; padding-bottom: 10px;">ìŠ¤í¬ë¦½íŠ¸ ë‚´ë³´ë‚´ê¸°</h3>
            <p style="color: #aaa; font-size: 12px; margin-bottom: 20px;">ì‚¬ìš©í•  ê²Œì„ ì—”ì§„ì— ë§ëŠ” í˜•ì‹ì„ ì„ íƒí•˜ì„¸ìš”.</p>
            
            <button class="btn" style="width: 100%; margin-bottom: 10px; text-align: left;" onclick="exportRenPyScript()">
                <strong style="color: #ffcc00;">ğŸ Ren'Py (.rpy)</strong>
                <div style="font-size: 10px; color: #888;">ê°€ì¥ ëŒ€ì¤‘ì ì¸ ë¹„ì£¼ì–¼ ë…¸ë²¨ ì—”ì§„ í¬ë§·ì…ë‹ˆë‹¤. ë¼ë²¨, ì í”„, ì„ íƒì§€ê°€ ìë™ ìƒì„±ë©ë‹ˆë‹¤.</div>
            </button>
    
            <button class="btn" style="width: 100%; margin-bottom: 10px; text-align: left;" onclick="exportUnityJSON()">
                <strong style="color: #fff;">ğŸ® Generic (.json)</strong>
                <div style="font-size: 10px; color: #888;">ì¢Œí‘œê°’ ì—†ì´ IDì™€ ë¡œì§ íë¦„ë§Œ ì •ë¦¬ëœ ë°ì´í„°ì…ë‹ˆë‹¤. ìœ ë‹ˆí‹°/ê³ ë„ ë“±ì—ì„œ íŒŒì‹±í•´ ì“°ì„¸ìš”.</div>
            </button>
    
            <div style="text-align: right; margin-top: 20px;">
                <button class="btn btn-danger" onclick="document.getElementById('export-modal').style.display='none'">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <!-- â–¼â–¼â–¼ ì´ë¯¸ì§€ ë‚´ë³´ë‚´ê¸° ëª¨ë‹¬ (ì—¬ê¸°ì— ìœ„ì¹˜í•´ì•¼ í•¨) â–¼â–¼â–¼ -->
    <div id="export-image-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 4000; align-items: center; justify-content: center;">
        <div class="modal-content" style="width: 350px; text-align: left;">
            <h3 style="margin-top: 0; color: #88ff88; border-bottom: 1px solid #444; padding-bottom: 10px;">ì´ë¯¸ì§€ ì €ì¥ ì˜µì…˜</h3>
            <p style="color: #aaa; font-size: 12px; margin-bottom: 20px;">ì €ì¥í•  ì˜ì—­ì„ ì„ íƒí•˜ì„¸ìš”.</p>
            
            <button class="btn" style="width: 100%; margin-bottom: 10px; text-align: left;" onclick="exportImageAction('all')">
                <strong style="color: #fff;">ğŸŒ ì „ì²´ ìº”ë²„ìŠ¤</strong>
                <div style="font-size: 10px; color: #888;">ëª¨ë“  ë…¸ë“œì™€ ê·¸ë£¹ì„ í¬í•¨í•˜ì—¬ ì €ì¥í•©ë‹ˆë‹¤.</div>
            </button>
    
            <button class="btn" style="width: 100%; margin-bottom: 10px; text-align: left;" onclick="exportImageAction('selected')">
                <strong style="color: var(--accent-cyan);">âœ… ì„ íƒëœ ìš”ì†Œë§Œ</strong>
                <div style="font-size: 10px; color: #888;">í˜„ì¬ ì„ íƒëœ ë…¸ë“œ/ê·¸ë£¹ë§Œ ì¶”ë ¤ë‚´ì–´ ì €ì¥í•©ë‹ˆë‹¤.</div>
            </button>
    
            <div style="text-align: right; margin-top: 20px;">
                <button class="btn btn-danger" onclick="document.getElementById('export-image-modal').style.display='none'">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <div id="type-manager-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 5000; align-items: center; justify-content: center;">
        <div class="modal-content" style="width: 400px; height: 500px; display: flex; flex-direction: column; text-align: left;">
            <h3 style="margin-top: 0; color: var(--accent-cyan); border-bottom: 1px solid #444; padding-bottom: 10px; display: flex; justify-content: space-between;">
                ë…¸ë“œ íƒ€ì… ê´€ë¦¬
                <button class="btn" onclick="addNodeType()" style="font-size: 12px;">+ ì¶”ê°€</button>
            </h3>
            
            <div id="type-list" style="flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; padding-right: 5px;">
                <!-- JSë¡œ ëª©ë¡ ìƒì„±ë¨ -->
            </div>
    
            <div style="text-align: right; margin-top: 20px; border-top: 1px solid #444; padding-top: 10px;">
                <button class="btn" onclick="closeTypeManager()">ë‹«ê¸° (ì ìš©)</button>
            </div>
        </div>
    </div>

    <div id="variable-manager-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 5000; align-items: center; justify-content: center;">
    <div class="modal-content" style="width: 500px; height: 600px; display: flex; flex-direction: column; text-align: left;">
        <h3 style="margin-top: 0; color: #d0a0ff; border-bottom: 1px solid #444; padding-bottom: 10px; display: flex; justify-content: space-between;">
            ê¸€ë¡œë²Œ ë³€ìˆ˜ í…Œì´ë¸”
            <button class="btn" onclick="addVariable()" style="font-size: 12px; border-color: #d0a0ff; color: #d0a0ff;">+ ë³€ìˆ˜ ì¶”ê°€</button>
        </h3>
        
        <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 40px; gap: 5px; padding: 5px; background: rgba(255,255,255,0.05); font-size: 11px; color: #aaa; margin-bottom: 5px;">
            <span>ë³€ìˆ˜ëª… (ID)</span>
            <span>íƒ€ì…</span>
            <span>ì´ˆê¸°ê°’</span>
            <span>ì‚­ì œ</span>
        </div>

        <div id="variable-list" style="flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 5px; padding-right: 5px;">
            <!-- JSë¡œ ëª©ë¡ ìƒì„±ë¨ -->
        </div>

        <div style="text-align: right; margin-top: 20px; border-top: 1px solid #444; padding-top: 10px;">
            <p style="font-size: 11px; color: #666; float: left; margin: 0; line-height: 30px;">â€» ìë™ì™„ì„± ë° ì´ˆê¸°í™”ì— ì‚¬ìš©ë©ë‹ˆë‹¤.</p>
            <button class="btn" onclick="closeVariableManager()">ë‹«ê¸° (ì ìš©)</button>
        </div>
    </div>
</div>

<!-- ìºë¦­í„° ê´€ë¦¬ì ëª¨ë‹¬ -->
<div id="char-manager-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 5000; align-items: center; justify-content: center;">
    <div class="modal-content" style="width: 400px; height: 500px; display: flex; flex-direction: column; text-align: left;">
        <h3 style="margin-top: 0; color: #ff99cc; border-bottom: 1px solid #444; padding-bottom: 10px; display: flex; justify-content: space-between;">
            ìºë¦­í„° ì„¤ì •
            <button class="btn" onclick="addCharacter()" style="font-size: 12px; border-color: #ff99cc; color: #ff99cc;">+ ì¶”ê°€</button>
        </h3>
        <div id="char-list" style="flex: 1; overflow-y: auto; padding-right: 5px;"></div>
        <div style="text-align: right; margin-top: 20px; border-top: 1px solid #444; padding-top: 10px;">
            <button class="btn" onclick="closeCharManager()">ë‹«ê¸°</button>
        </div>
    </div>
</div>

    <input type="file" id="json-input" style="display: none;" accept=".json">
    <div id="toast">ë©”ì‹œì§€</div>
    <div id="selection-box"></div>

    <script>
        // --- Global Variables ---
        let metaData = { folders: ['Default'], projects: [] };
        let currentProjectId = null; let currentFolder = 'Default';
        let nodes = [], connections = [], groups = [];
        let nodeTypes = [
            { id: 'normal', name: 'ì¼ë°˜ ì¥ë©´', color: '#00f0ff' },
            { id: 'choice', name: 'ì„ íƒì§€', color: '#ffcc00' },
            { id: 'dead', name: 'ë°°ë“œ ì—”ë”©', color: '#ff3333' }
        ];
        let scale = 1, panX = 0, panY = 0;
        let selectedIds = new Set(), selectionType = null;
        let interactMode = 'pan', isDragging = false, dragType = null, dragId = null;
        let lastPos = {x:0, y:0}, dragOffset = {x:0, y:0}, lastTapTime = 0;
        let isConnectMode = false, initialPinchDist = 0, initialScale = 1, initialPinchCenter = {x:0,y:0}, initialPan = {x:0,y:0};
        let selectStartWorldPos = {x:0, y:0};
        let selectStartScreenPos = {x:0, y:0}; // [ì¶”ê°€] í™”ë©´ ê¸°ì¤€ ì‹œì‘ì  ì €ì¥ìš©
        let historyStack = [], historyIndex = -1; const MAX_HISTORY = 50;
        let clipboard = null, searchResults = [], searchIndex = -1;
        let connectSourceId = null; // ì—°ê²° ì‹œì‘ ë…¸ë“œ IDë¥¼ ì €ì¥í•  ë³€ìˆ˜
        let sceneCounter = 1;
        let isTicking = false; // í™”ë©´ ê°±ì‹  ì˜ˆì•½ ì—¬ë¶€
        let lastMoveEvent = null; // ë§ˆì§€ë§‰ ì´ë²¤íŠ¸ ê°ì²´ ì €ì¥
        let isLodMode = false; // í˜„ì¬ LOD ëª¨ë“œì¸ì§€ ì—¬ë¶€
        let cachedRelatedLinks = [];
        let globalVars = [];
        let characters = []; // ìºë¦­í„° ë°ì´í„° ì €ì¥ì†Œ: { id, name, color }
// Play Mode State
let playState = {
    currentNode: null,
    dialogueIndex: 0,
    isWaitingChoice: false
};

        const NODE_W = 160, NODE_H = 90;
        const GRID_X = 200, GRID_Y = 140; 
        const START_X = 100, START_Y = 100;
        const THRESHOLD = 10; 
        const LINE_COLORS = ["rgba(100, 200, 255, 0.6)", "rgba(255, 100, 255, 0.6)", "rgba(100, 255, 150, 0.6)", "rgba(255, 180, 50, 0.6)", "rgba(150, 150, 255, 0.6)"];

        // DOM Elements
        const screenHome=document.getElementById('screen-home'); const screenEditor=document.getElementById('screen-editor');
        const folderList=document.getElementById('folder-list'); const projectList=document.getElementById('project-list');
        const canvasArea=document.getElementById('canvas-area'); const world=document.getElementById('world-container');
        const nodesLayer=document.getElementById('nodes-layer'); const sepLayer=document.getElementById('separator-layer'); const svgLayer=document.getElementById('svg-layer');
        const panel=document.getElementById('detail-panel'); const confirmModal=document.getElementById('confirm-modal');
        const fileExplorer=document.getElementById('file-explorer'); const fileList=document.getElementById('file-list');
        const jsonInput=document.getElementById('json-input'); const jsonInputHome=document.getElementById('json-input-home');
        const minimap=document.getElementById('minimap'); const minimapCanvas=document.getElementById('minimap-canvas'); const minimapCtx=minimapCanvas.getContext('2d'); const minimapViewport=document.getElementById('minimap-viewport');
        const selectBox=document.getElementById('selection-box'); const btnMode=document.getElementById('btn-mode');
        // const btnConnect=document.getElementById('btn-connect');
        const firebaseConfig = {
  apiKey: "AIzaSyCrEZXGpddEYxSPMLF-NlG4wkUS2R1CzR4",
  authDomain: "flow-chart-maker.firebaseapp.com",
  databaseURL: "https://flow-chart-maker-default-rtdb.firebaseio.com",
  projectId: "flow-chart-maker",
  storageBucket: "flow-chart-maker.firebasestorage.app",
  messagingSenderId: "901247220090",
  appId: "1:901247220090:web:5bc7553ca4ba465086fec3",
  measurementId: "G-PJ289GD4P7"
};


        // Firebase ì´ˆê¸°í™” (ì—ëŸ¬ ë°©ì§€ ì²´í¬)
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.database();
        let currentUser = null;

        // 2. ë¡œê·¸ì¸ í•¨ìˆ˜
        function googleLogin() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .then((result) => {
                    currentUser = result.user;
                    updateAuthUI();
                    syncFromCloud(); // ë¡œê·¸ì¸ ì‹œ í´ë¼ìš°ë“œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
                    showToast(`í™˜ì˜í•©ë‹ˆë‹¤, ${currentUser.displayName}ë‹˜!`);
                }).catch((error) => {
                    console.error(error);
                    alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: " + error.message);
                });
        }

        // 3. ë¡œê·¸ì•„ì›ƒ í•¨ìˆ˜
        function googleLogout() {
            auth.signOut().then(() => {
                currentUser = null;
                updateAuthUI();
                // ë¡œê·¸ì•„ì›ƒ ì‹œ ë¡œì»¬ ë°ì´í„°ë¡œ ë³µê·€í•˜ê±°ë‚˜ ì´ˆê¸°í™”
                loadMetaData(); 
                renderHome();
                showToast("ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.");
            });
        }

        // 4. UI ì—…ë°ì´íŠ¸
        function updateAuthUI() {
            const btnLogin = document.getElementById('btn-login');
            const btnLogout = document.getElementById('btn-logout');
            const userDisplay = document.getElementById('user-display');

            if (currentUser) {
                btnLogin.style.display = 'none';
                btnLogout.style.display = 'inline-flex';
                userDisplay.textContent = `â˜ï¸ ${currentUser.displayName}`;
            } else {
                btnLogin.style.display = 'inline-flex';
                btnLogout.style.display = 'none';
                userDisplay.textContent = '';
            }
        }

        // 5. í´ë¼ìš°ë“œ -> ë¡œì»¬ ë™ê¸°í™” (ë¶ˆëŸ¬ì˜¤ê¸°)
        function syncFromCloud() {
            if (!currentUser) return;
            const uid = currentUser.uid;
            
            showToast("â˜ï¸ í´ë¼ìš°ë“œ ë™ê¸°í™” ì¤‘...");
            
            db.ref('users/' + uid).once('value').then((snapshot) => {
                const data = snapshot.val();
                if (data) {
                    // ë©”íƒ€ë°ì´í„° ë³‘í•©
                    if (data.meta) {
                        metaData = data.meta;
                        localStorage.setItem('tsuki_meta', JSON.stringify(metaData));
                    }
                    // ê°œë³„ í”„ë¡œì íŠ¸ ë°ì´í„° ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
                    if (data.projects) {
                        for (const [pid, pdata] of Object.entries(data.projects)) {
                            localStorage.setItem('tsuki_data_' + pid, JSON.stringify(pdata));
                        }
                    }
                    renderHome();
                    showToast("âœ… ë™ê¸°í™” ì™„ë£Œ!");
                } else {
                    // í´ë¼ìš°ë“œì— ë°ì´í„°ê°€ ì—†ìœ¼ë©´ í˜„ì¬ ë¡œì»¬ ë°ì´í„°ë¥¼ ì—…ë¡œë“œ
                    syncToCloud();
                }
            });
        }

        // 6. ë¡œì»¬ -> í´ë¼ìš°ë“œ ë™ê¸°í™” (ì €ì¥í•˜ê¸°)
        function syncToCloud() {
            if (!currentUser) return;
            const uid = currentUser.uid;

            // 1. ë©”íƒ€ë°ì´í„° ì €ì¥
            db.ref('users/' + uid + '/meta').set(metaData);

            // 2. ëª¨ë“  í”„ë¡œì íŠ¸ ë°ì´í„° ì €ì¥ (ì£¼ì˜: ë°ì´í„°ê°€ ë§ìœ¼ë©´ ë¹„íš¨ìœ¨ì ì¼ ìˆ˜ ìˆìŒ. ì‹¤ì œë¡œëŠ” ë³€ê²½ëœ ê²ƒë§Œ ì €ì¥ ê¶Œì¥)
            // ì—¬ê¸°ì„œëŠ” í˜„ì¬ ì—´ë¦° í”„ë¡œì íŠ¸ í˜¹ì€ ì „ì²´ë¥¼ ë®ì–´ì“°ëŠ” ë‹¨ìˆœ ë°©ì‹ìœ¼ë¡œ êµ¬í˜„
            if (currentProjectId) {
                 const raw = localStorage.getItem('tsuki_data_' + currentProjectId);
                 if (raw) {
                     const pdata = JSON.parse(raw);
                     db.ref('users/' + uid + '/projects/' + currentProjectId).set(pdata);
                 }
            }
        }

        // ì•± ì‹œì‘ ì‹œ ë¡œê·¸ì¸ ìƒíƒœ ì²´í¬
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                updateAuthUI();
                // ìë™ ë™ê¸°í™”ë¥¼ ì›í•˜ë©´ ì—¬ê¸°ì„œ syncFromCloud() í˜¸ì¶œ
                // syncFromCloud(); 
            } else {
                currentUser = null;
                updateAuthUI();
            }
        });

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
    loadMetaData(); 
    renderHome();
    
    canvasArea.addEventListener('mousedown', handleStart);
    canvasArea.addEventListener('touchstart', handleStart, { passive: false });
    window.addEventListener('mousemove', handleMove, { passive: false });
    window.addEventListener('touchmove', handleMove, { passive: false });
    window.addEventListener('mouseup', handleEnd);
    window.addEventListener('touchend', handleEnd);
    canvasArea.addEventListener('wheel', handleWheel, { passive: false });
    window.addEventListener('keydown', handleKey);
    
    setupAutocomplete('req-var', 'req-var-list');
    setupAutocomplete('act-var', 'act-var-list');

    // [ìˆ˜ì •ë¨] input-desc ì œê±° ë° input-summary ì¶”ê°€, input-typeì€ change ì´ë²¤íŠ¸ë¡œ ë³€ê²½
    ['input-title', 'input-req', 'input-act'].forEach(id => {
        const el = document.getElementById(id);
        if(el) el.addEventListener('input', updateNodeData);
    });
    
    // Select íƒœê·¸ëŠ” change ì´ë²¤íŠ¸ê°€ ë” ì•ˆì •ì ì…ë‹ˆë‹¤.
    const typeSelect = document.getElementById('input-type');
    if(typeSelect) {
        typeSelect.addEventListener('change', updateNodeData);
        typeSelect.addEventListener('input', updateNodeData);
    }

    ['input-sep-label','input-sep-desc'].forEach(id => {
        const el = document.getElementById(id);
        if(el) el.addEventListener('input', updateSepData);
    });

    jsonInput.addEventListener('change', handleJSONUpload);
    jsonInputHome.addEventListener('change', handleJSONUpload);
    minimap.addEventListener('mousedown', handleMinimapPan);
    
    // ë¡œì§ ë¹Œë” ê´€ë ¨ ë¦¬ìŠ¤ë„ˆ (ê¸°ì¡´ ìœ ì§€)
    document.querySelectorAll('#req-var, #req-op, #req-val, #act-var, #act-op, #act-val').forEach(el => {
        el.addEventListener('input', updateNodeData);
        el.addEventListener('change', updateNodeData);
    });
    
    // ê·¸ë£¹ ê´€ë ¨ ë¦¬ìŠ¤ë„ˆ (ê¸°ì¡´ ìœ ì§€)
    const grpTitle = document.getElementById('input-group-title');
    const grpColor = document.getElementById('input-group-color');
    if (grpTitle) grpTitle.addEventListener('input', window.updateGroupData);
    if (grpColor) {
        grpColor.addEventListener('input', window.updateGroupData);
        grpColor.addEventListener('change', window.updateGroupData);
    }
});

        // --- Home Logic ---
        function loadMetaData() { 
            const r = localStorage.getItem('tsuki_meta'); 
            if(r) {
                metaData = JSON.parse(r);
                // [ì¶”ê°€] ë©”íƒ€ë°ì´í„°ì— ì €ì¥ëœ íƒ€ì… ì •ë³´ê°€ ìˆìœ¼ë©´ ë¶ˆëŸ¬ì˜¤ê¸°
                if(metaData.nodeTypes) nodeTypes = metaData.nodeTypes;
            } else {
                saveMetaData(); 
            }
        }

        function saveMetaData() { 
            // [ì¶”ê°€] íƒ€ì… ì •ë³´ë„ ê°™ì´ ì €ì¥
            metaData.nodeTypes = nodeTypes;
            localStorage.setItem('tsuki_meta', JSON.stringify(metaData)); 
        }
        function renderHome() {
    screenHome.classList.add('active'); 
    screenEditor.classList.remove('active');
    
    // UI ì´ˆê¸°í™”
    document.getElementById('detail-panel').classList.remove('active');
    
    // í´ë” íƒ­ ë Œë”ë§
    folderList.innerHTML = '';
    metaData.folders.forEach(f => {
        const t = document.createElement('div'); 
        t.className = `folder-tab ${f === currentFolder ? 'active' : ''}`; 
        t.textContent = f;
        t.onclick = () => { currentFolder = f; renderHome(); }; 
        folderList.appendChild(t);
    });
    
    const addT = document.createElement('div'); 
    addT.className = 'folder-tab'; 
    addT.textContent = '+';
    addT.onclick = () => {
        const n = prompt('í´ë”ëª…:'); 
        if (n && !metaData.folders.includes(n)) {
            metaData.folders.push(n); 
            saveMetaData(); 
            renderHome();
        }
    };
    folderList.appendChild(addT);
    
    // í”„ë¡œì íŠ¸ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
    projectList.innerHTML = '';
    const flt = metaData.projects.filter(p => p.folder === currentFolder).sort((a, b) => b.updated - a.updated);
    
    flt.forEach(p => {
        // 1. ì¹´ë“œ ì»¨í…Œì´ë„ˆ ìƒì„±
        const c = document.createElement('div'); 
        c.className = 'project-card';
        c.onclick = () => openProject(p.id); // ì¹´ë“œ í´ë¦­ ì‹œ í”„ë¡œì íŠ¸ ì—´ê¸°

        // 2. ì œëª© ì˜ì—­ ìƒì„±
        const titleDiv = document.createElement('div');
        titleDiv.className = 'card-title';
        titleDiv.id = `title-${p.id}`;
        titleDiv.textContent = p.name;

        // 3. ë‚ ì§œ ì˜ì—­ ìƒì„±
        const infoDiv = document.createElement('div');
        infoDiv.className = 'card-info';
        infoDiv.textContent = new Date(p.updated).toLocaleString();

        // 4. ë²„íŠ¼ ì˜ì—­ ìƒì„±
        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'card-actions';

        // [ì‚­ì œ ë²„íŠ¼] - ì§ì ‘ ìš”ì†Œ ìƒì„± ë° ì´ë²¤íŠ¸ ì—°ê²°
        const btnDel = document.createElement('button');
        btnDel.className = 'card-btn';
        btnDel.textContent = 'ì‚­ì œ';
        // ì—¬ê¸°ì„œ ì§ì ‘ stopPropagationì„ í˜¸ì¶œí•˜ì—¬ ì¹´ë“œ í´ë¦­ ë°©ì§€
        btnDel.onclick = (e) => {
            e.stopPropagation(); 
            askDeleteProjectInHome(p.id);
        };
        // ë§ˆìš°ìŠ¤ ì˜¤ë²„ íš¨ê³¼ (ì˜µì…˜)
        btnDel.onmouseover = () => btnDel.style.background = '#500';
        btnDel.onmouseout = () => btnDel.style.background = '#333';

        // [ì´ë¦„ë³€ê²½ ë²„íŠ¼]
        const btnRen = document.createElement('button');
        btnRen.className = 'card-btn';
        btnRen.textContent = 'ì´ë¦„ë³€ê²½';
        btnRen.onclick = (e) => {
            e.stopPropagation();
            startInlineRename(p.id);
        };

        // ìš”ì†Œ ì¡°ë¦½
        actionsDiv.appendChild(btnDel);
        actionsDiv.appendChild(btnRen);

        c.appendChild(titleDiv);
        c.appendChild(infoDiv);
        c.appendChild(actionsDiv);

        projectList.appendChild(c);
    });
}

// --- [ìˆ˜ì •] í”„ë¡œì íŠ¸ ì‚­ì œ ê¸°ëŠ¥ (í™ˆ í™”ë©´ìš©) ---
function askDeleteProjectInHome(id) {
    // e.stopPropagation() ì œê±° (ì´ë¯¸ ë²„íŠ¼ í´ë¦­ ì‹œ ì²˜ë¦¬ë¨)
    
    openCustomModal("ì´ í”„ë¡œì íŠ¸ë¥¼ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?", [
        { 
            text: "ì‚­ì œ", 
            class: "btn btn-danger", 
            action: () => { 
                // 1. ë¡œì»¬ ë°ì´í„° ì‚­ì œ
                localStorage.removeItem('tsuki_data_' + id);
                
                // 2. ë©”íƒ€ë°ì´í„°ì—ì„œ ì œê±°
                metaData.projects = metaData.projects.filter(p => p.id !== id);
                saveMetaData();
                
                // 3. í´ë¼ìš°ë“œ ë™ê¸°í™”
                if (currentUser) syncToCloud();

                // 4. ëª¨ë‹¬ ë‹«ê³  í™”ë©´ ê°±ì‹ 
                closeModal();
                renderHome(); // ì‚­ì œ í›„ ëª©ë¡ ê°±ì‹ 
                showToast("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
            } 
        },
        { 
            text: "ì·¨ì†Œ", 
            class: "btn", 
            action: closeModal 
        }
    ]);
}


// --- [ì‹ ê·œ] ì¸ë¼ì¸ ì´ë¦„ ë³€ê²½ ì‹œì‘ ---
function startInlineRename(id) {
    // e.stopPropagation() ì œê±° (ì´ë¯¸ ë²„íŠ¼ í´ë¦­ ì‹œ ì²˜ë¦¬ë¨)

    const titleEl = document.getElementById(`title-${id}`);
    if (!titleEl) return;

    const currentName = titleEl.innerText;
    
    // input íƒœê·¸ ìƒì„± (í´ë¦­ ì´ë²¤íŠ¸ ì „íŒŒ ë°©ì§€ í¬í•¨)
    titleEl.innerHTML = ''; // ê¸°ì¡´ í…ìŠ¤íŠ¸ ë¹„ìš°ê¸°
    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'rename-input';
    input.value = currentName;
    input.onclick = (e) => e.stopPropagation(); // ì…ë ¥ì°½ í´ë¦­ ì‹œ í”„ë¡œì íŠ¸ ì—´ë¦¼ ë°©ì§€
    
    titleEl.appendChild(input);
    
    input.focus();
    input.select();

    // ì €ì¥ íŠ¸ë¦¬ê±°
    input.onblur = () => finishInlineRename(id, input.value);
    input.onkeydown = (k) => {
        if (k.key === 'Enter') input.blur();
    };
}

function finishInlineRename(id, newName) {
    const cleanName = newName.trim();
    if (!cleanName) {
        renderHome();
        return;
    }

    const proj = metaData.projects.find(p => p.id === id);
    if (proj) {
        proj.name = cleanName;
        saveMetaData();
        if (currentUser) syncToCloud();
    }
    renderHome();
}

        function createNewProject() {
            const name=prompt("í”„ë¡œì íŠ¸ ì´ë¦„:", "New Project"); if(!name)return;
            const id='proj_'+Date.now();
            const initData={nodes:[{id:'n_'+Date.now(),x:START_X,y:START_Y,title:'Start',type:'normal',desc:''}],connections:[],separators:[],panX:0,panY:0,scale:1};
            localStorage.setItem('tsuki_data_'+id, JSON.stringify(initData));
            metaData.projects.push({id,name,folder:currentFolder,updated:Date.now()}); saveMetaData(); openProject(id);
        }
        function openProject(id) {
    currentProjectId = id;
    document.getElementById('detail-panel').classList.remove('active'); // íŒ¨ë„ ë‹«ê¸°
    selectedIds.clear(); // ì„ íƒëœ ë…¸ë“œ/ê·¸ë£¹ í•´ì œ
    selectionType = null; // ì„ íƒ íƒ€ì… ì´ˆê¸°í™”
    document.activeElement.blur(); // ì…ë ¥ì°½ í¬ì»¤ìŠ¤ í•´ì œ (í‚¤ë³´ë“œ ì´ë²¤íŠ¸ ë°©ì§€)
    const proj = metaData.projects.find(p => p.id === id);
    document.getElementById('current-project-name').textContent = proj ? proj.name : 'Imported';
    const raw = localStorage.getItem('tsuki_data_' + id);
    
    if (raw) {
        const d = JSON.parse(raw);
        nodes = d.nodes || [];
        connections = d.connections || [];
        groups = d.groups || [];
        globalVars = d.globalVars || []; // ë³€ìˆ˜ ë°ì´í„° ë¡œë“œ
        panX = d.panX || 0;
        panY = d.panY || 0;
        scale = d.scale || 1;
        characters = d.characters || [];
    } else {
        nodes = [];
        connections = [];
        groups = [];
        globalVars = [];
    }

    if (nodes.length > 0) {
        const maxNum = nodes.reduce((max, n) => {
            const match = n.title.match(/ì¥ë©´\s*(\d+)/);
            return match ? Math.max(max, parseInt(match[1])) : max;
        }, 0);
        sceneCounter = maxNum + 1;
    } else {
        sceneCounter = 1;
    }

    // [ìˆ˜ì •] ì‚­ì œí•¨: updateDatalist(); (ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ)
    
    screenHome.classList.remove('active');
    screenEditor.classList.add('active');
    
    historyStack = [];
    historyIndex = -1;
    migrateConnections();
    pushHistory(true);
    fitToScreen();
    render();
}
        function saveCurrentProject() {
            if(!currentProjectId) return;
            
            // [í™•ì¸] separators ì‚­ì œë¨, groups í¬í•¨ë¨
            const d={nodes, connections, groups, globalVars, panX, panY, scale};
            
            localStorage.setItem('tsuki_data_'+currentProjectId, JSON.stringify(d));
            
            const p=metaData.projects.find(x=>x.id===currentProjectId); 
            if(p) p.updated=Date.now();
            saveMetaData(); 
            
            // â–¼â–¼â–¼ [ì¶”ê°€] í´ë¼ìš°ë“œ ì €ì¥ íŠ¸ë¦¬ê±° â–¼â–¼â–¼
            if (currentUser) {
                syncToCloud(); // í˜„ì¬ í”„ë¡œì íŠ¸ ë° ë©”íƒ€ë°ì´í„°ë¥¼ Firebaseë¡œ ì „ì†¡
                showToast("ì €ì¥ë¨ (â˜ï¸ í´ë¼ìš°ë“œ ë°±ì—… ì™„ë£Œ)");
            } else {
                showToast("ì €ì¥ë¨ (ë¡œì»¬)");
            }
            // â–²â–²â–² [ì¶”ê°€] ë â–²â–²â–²
        }
        function deleteProject(id) {
            openCustomModal("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?", [
                { text: "ì‚­ì œ", class: "btn btn-danger", action: () => { localStorage.removeItem('tsuki_data_'+id); metaData.projects=metaData.projects.filter(p=>p.id!==id); saveMetaData(); renderHome(); closeModal(); } },
                { text: "ì·¨ì†Œ", class: "btn", action: closeModal }
            ]);
        }
        function renameProject(id) { const p=metaData.projects.find(x=>x.id===id); const n=prompt("ìƒˆ ì´ë¦„:", p.name); if(n){p.name=n; saveMetaData(); renderHome();} }
        function tryGoHome() {
            openCustomModal("í™ˆìœ¼ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?", [
                { text: "ì €ì¥ í›„ ì´ë™", class: "btn", action: () => { saveCurrentProject(); renderHome(); closeModal(); } },
                { text: "ì €ì¥ ì•ˆ í•¨", class: "btn btn-danger", action: () => { renderHome(); closeModal(); } },
                { text: "ì·¨ì†Œ", class: "btn", action: closeModal }
            ]);
        }

        // --- Editor ---
        function toggleToolbar() { document.getElementById('toolbar').classList.toggle('hidden'); }
        function toggleMinimap() { const m=document.getElementById('minimap'); m.style.display=(m.style.display==='block')?'none':'block'; if(m.style.display==='block')updateMinimap(); }
        function openCustomModal(msg, buttons) {
            document.getElementById('confirm-msg').textContent = msg;
            const actionDiv = document.getElementById('modal-actions'); actionDiv.innerHTML = '';
            buttons.forEach(btn => {
                const b = document.createElement('button'); b.textContent = btn.text; b.className = btn.class; b.onclick = btn.action; actionDiv.appendChild(b);
            });
            confirmModal.style.display = 'flex';
        }
        function closeModal() { confirmModal.style.display='none'; }
        function tryDeleteSelection() { 
            if(selectedIds.size===0)return; 
            openCustomModal(`${selectedIds.size}ê°œ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, [
                { text: "ì‚­ì œ", class: "btn btn-danger", action: () => { deleteSelected(); closeModal(); } },
                { text: "ì·¨ì†Œ", class: "btn", action: closeModal }
            ]);
        }
        function deleteSelected() {
            if(selectionType==='node'){
                const idsToRemove=new Set(selectedIds);
                nodes=nodes.filter(n=>!idsToRemove.has(n.id));
                connections=connections.filter(c=>!idsToRemove.has(c.from)&&!idsToRemove.has(c.to));
            } 
            // [ìˆ˜ì •] separator -> group ë¡œì§ìœ¼ë¡œ ë³€ê²½
            else if(selectionType==='group'){
                groups=groups.filter(g=>!selectedIds.has(g.id));
            } 
            else if(selectionType==='connection'){
                connections=connections.filter(c=>!selectedIds.has(c.id));
            }
            selectedIds.clear(); selectionType=null; closePanel(); 
            requestAnimationFrame(render); pushHistory();
        }

        function handleJSONUpload(e) {
            const f=e.target.files[0]; if(!f)return;
            const r=new FileReader(); r.onload=(ev)=>{
                try{
                    const d=JSON.parse(ev.target.result);
                    if(d.nodes){
                        const nid='proj_imp_'+Date.now(); const nname=f.name.replace('.json','');
                        const np={id:nid, name:nname, folder:currentFolder, updated:Date.now()};
                        if(d.connections) d.connections.forEach(c=>{if(!c.id)c.id='conn_'+Math.random().toString(36).substr(2,9);});
                        localStorage.setItem('tsuki_data_'+nid, JSON.stringify(d));
                        metaData.projects.push(np); saveMetaData();
                        closeFileExplorer(); showToast("ë¡œë“œ ì™„ë£Œ"); openProject(nid);
                    } else throw new Error();
                }catch(er){alert("íŒŒì¼ ì˜¤ë¥˜");}
            }; r.readAsText(f); e.target.value='';
        }

        function openFileExplorer() { fileExplorer.style.display='flex'; refreshFileList(); }
        function closeFileExplorer() { fileExplorer.style.display='none'; }
        function refreshFileList() {
            fileList.innerHTML='';
            const flt=metaData.projects.filter(p=>p.folder===currentFolder).sort((a,b)=>b.updated-a.updated);
            flt.forEach(p=>{
                const item=document.createElement('div'); item.className='file-item';
                // [ìˆ˜ì •] ì—´ê¸° ë²„íŠ¼ í´ë¦­ ì‹œ tryLoadProject í˜¸ì¶œ
                item.innerHTML=`<div><div class="file-name">${p.name}</div><div class="file-date">${new Date(p.updated).toLocaleString()}</div></div><div class="file-actions"><button onclick="tryLoadProject('${p.id}')">ì—´ê¸°</button><button class="btn-danger" onclick="askDeleteProject('${p.id}')">ì‚­ì œ</button></div>`;
                fileList.appendChild(item);
            });
        }
        window.tryLoadProject = (id) => {
            // í˜„ì¬ í”„ë¡œì íŠ¸ì™€ ë™ì¼í•˜ë©´ ê·¸ëƒ¥ ë‹«ê¸°
            if (id === currentProjectId) {
                closeFileExplorer();
                return;
            }

            // í™•ì¸ ëª¨ë‹¬ ë„ìš°ê¸° (íŒŒì¼ íƒìƒ‰ê¸°ë³´ë‹¤ ìœ„ì— ë– ì•¼ í•¨)
            // confirm-modalì˜ z-indexëŠ” 9999ì´ë¯€ë¡œ 3000ì¸ file-explorerë³´ë‹¤ ìœ„ì— ëœ¹ë‹ˆë‹¤. OK.
            openCustomModal("í˜„ì¬ í”„ë¡œì íŠ¸ë¥¼ ì €ì¥í•˜ê³  ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?", [
                { 
                    text: "ì €ì¥ í›„ ì—´ê¸°", 
                    class: "btn", 
                    action: () => { 
                        saveCurrentProject(); 
                        openProject(id); 
                        closeFileExplorer(); 
                        closeModal(); 
                    } 
                },
                { 
                    text: "ì €ì¥ ì•ˆ í•¨", 
                    class: "btn btn-danger", 
                    action: () => { 
                        openProject(id); 
                        closeFileExplorer(); 
                        closeModal(); 
                    } 
                },
                { 
                    text: "ì·¨ì†Œ", 
                    class: "btn", 
                    action: closeModal 
                }
            ]);
        };
        window.loadProject=(id)=>{openProject(id); closeFileExplorer();};
        window.askDeleteProject=(id)=>{
            openCustomModal("ì´ í”„ë¡œì íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?", [
                { text: "ì‚­ì œ", class: "btn btn-danger", action: () => { localStorage.removeItem('tsuki_data_'+id); metaData.projects=metaData.projects.filter(p=>p.id!==id); saveMetaData(); refreshFileList(); closeModal(); } },
                { text: "ì·¨ì†Œ", class: "btn", action: closeModal }
            ]);
        };
        function saveToBrowser() { saveCurrentProject(); refreshFileList(); }
        function exportJSON() { if(!currentProjectId)return; const raw=localStorage.getItem('tsuki_data_'+currentProjectId); const b=new Blob([raw],{type:"application/json"}); const l=document.createElement('a'); l.href=URL.createObjectURL(b); l.download=`flowchart_${Date.now()}.json`; l.click(); }

        // Core Logic
        function migrateConnections() { connections.forEach(c=>{if(!c.id)c.id='conn_'+Math.random().toString(36).substr(2,9);}); }
        function pushHistory(isInit) { 
            // [ìˆ˜ì •] separators -> groups ë¡œ ë³€ê²½
            const s=JSON.stringify({nodes,connections,groups}); 
            if(!isInit&&historyStack[historyIndex]===s)return; 
            historyStack=historyStack.slice(0,historyIndex+1); 
            historyStack.push(s); 
            if(historyStack.length>MAX_HISTORY)historyStack.shift(); 
            else historyIndex++; 
        }
        
        function undo() { if(historyIndex>0){historyIndex--; loadFromHistory();} }
        function redo() { if(historyIndex<historyStack.length-1){historyIndex++; loadFromHistory();} }
        
        function loadFromHistory() { 
            const d=JSON.parse(historyStack[historyIndex]); 
            nodes=d.nodes; 
            connections=d.connections; 
            // [ìˆ˜ì •] separators -> groups ë¡œ ë³€ê²½
            groups=d.groups || []; 
            selectedIds.clear(); 
            closePanel(); 
            render(); 
        }
        function handleKey(e) { 
    // [ìˆ˜ì •ë¨] í˜„ì¬ í¬ì»¤ìŠ¤ê°€ ì…ë ¥ ìš”ì†Œì¸ì§€ í™•ì¸
    const target = document.activeElement;
    const isInput = target.tagName === 'INPUT' || 
                    target.tagName === 'TEXTAREA' || 
                    target.tagName === 'SELECT' || 
                    target.isContentEditable;

    // ì…ë ¥ ì¤‘ì´ë¼ë©´ ì „ì—­ ë‹¨ì¶•í‚¤ ë¡œì§ ì‹¤í–‰ ì•ˆ í•¨ (í…ìŠ¤íŠ¸ ë³µì‚¬/ë¶™ì—¬ë„£ê¸° í—ˆìš©)
    if (isInput) return; 

    // ê¸°ì¡´ ë‹¨ì¶•í‚¤ ë¡œì§ (ë…¸ë“œ ë³µì‚¬/ë¶™ì—¬ë„£ê¸° ë“±)
    if ((e.ctrlKey || e.metaKey)) {
        if (e.key === 'z') { e.preventDefault(); undo(); }
        if (e.key === 'y') { e.preventDefault(); redo(); }
        if (e.key === 'c') { e.preventDefault(); copySelected(); }
        if (e.key === 'v') { e.preventDefault(); pasteNodes(); }
    } 
}
        function toggleInteractMode() { interactMode=(interactMode==='pan')?'select':'pan'; document.getElementById('btn-mode').textContent=interactMode==='pan'?'ì´ë™':'ì„ íƒ'; document.getElementById('btn-mode').classList.toggle('active',interactMode==='select'); canvasArea.classList.toggle('select-mode',interactMode==='select'); showToast(interactMode==='pan'?'ì´ë™ ëª¨ë“œ':'ë‹¤ì¤‘ ì„ íƒ ëª¨ë“œ'); }
        function getPos(e) { return e.touches ? {x:e.touches[0].clientX,y:e.touches[0].clientY} : {x:e.clientX,y:e.clientY}; }
        function getPinchDist(e) { return Math.hypot(e.touches[0].clientX-e.touches[1].clientX, e.touches[0].clientY-e.touches[1].clientY); }
        function getPinchCenter(e) { return {x:(e.touches[0].clientX+e.touches[1].clientX)/2, y:(e.touches[0].clientY+e.touches[1].clientY)/2}; }
        
        /* [ìˆ˜ì •ëœ handleStart] ì—°ê²°ì„  ì„ íƒ ë¡œì§ ë²„ê·¸ ìˆ˜ì • */
        function handleStart(e) {
    // 0. ì´ë²¤íŠ¸ ìœ„ì„: data-action ì†ì„± í™•ì¸
    const actionEl = e.target.closest('[data-action]');
    if (actionEl) {
        // ë²„íŠ¼/í—¤ë” í´ë¦­ ì‹œ ê¸°ë³¸ ë“œë˜ê·¸ ë°©ì§€
        e.stopPropagation();
        // e.preventDefault(); // ì…ë ¥ì°½ í¬ì»¤ìŠ¤ ë¬¸ì œ ë“±ì„ ìœ„í•´ ìƒí™©ì— ë”°ë¼ ì£¼ì„ ì²˜ë¦¬ ê°€ëŠ¥í•˜ë‚˜, ë³´í†µ ë²„íŠ¼ì—” í•„ìš”

        const action = actionEl.dataset.action;
        const id = actionEl.dataset.id;

        // ì•¡ì…˜ë³„ ë¶„ê¸° ì²˜ë¦¬
        if (action === 'link') {
            startLinkMode(e, id);
        } else if (action === 'delete-node') {
            deleteNodeDirect(e, id);
        } else if (action === 'delete-conn') {
            deleteConnectionDirect(e, id);
        } else if (action === 'group-drag') {
            startGroupDrag(e, id);
        } else if (action === 'group-resize') {
            startGroupResize(e, id);
        }
        return; // ì•¡ì…˜ì„ ì²˜ë¦¬í–ˆìœ¼ë©´ ì¢…ë£Œ
    }

    // 1. ì œì™¸ ëŒ€ìƒ ì²´í¬ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
    if (e.target.closest('.node-actions') || 
        e.target.closest('.connection-actions') || 
        e.target.closest('#toolbar') || 
        e.target.closest('#detail-panel') || 
        e.target.closest('.input-group') || 
        e.target.closest('button') || 
        e.target.closest('#minimap') || 
        e.target.closest('#toolbar-toggle')) return;
    
    // 2. í•€ì¹˜ ì¤Œ ì´ˆê¸°í™”
    if (e.touches && e.touches.length === 2) {
        isDragging = false;
        initialPinchDist = getPinchDist(e);
        initialScale = scale;
        initialPinchCenter = getPinchCenter(e);
        initialPan = { x: panX, y: panY };
        return;
    }

    const pos = getPos(e);
    const wx = (pos.x - panX) / scale;
    const wy = (pos.y - panY) / scale;
    
    const ne = e.target.closest('.node');
    const le = e.target.closest('.link-hit');

    // 3. ì—°ê²° ëª¨ë“œ (Connect Mode)
    if (connectSourceId) {
        e.preventDefault();
        if (ne) {
            completeLink(ne.id);
        } else {
            showToast("ì—°ê²° ì·¨ì†Œ");
            connectSourceId = null;
            render();
        }
        return;
    }

    // 4. ì„ íƒ ëª¨ë“œ (Select Mode)
    if (interactMode === 'select' && !ne && !le) {
        isDragging = false; 
        dragType = 'box-select';
        
        // ì›”ë“œ ì¢Œí‘œ: ë‚˜ì¤‘ì— ì–´ë–¤ ë…¸ë“œê°€ ì„ íƒë˜ì—ˆëŠ”ì§€ ê³„ì‚°í•  ë•Œ ì‚¬ìš©
        selectStartWorldPos = { x: wx, y: wy };
        // í™”ë©´ ì¢Œí‘œ: ë°•ìŠ¤ë¥¼ ê·¸ë¦´ ë•Œ ì‚¬ìš© (e.clientX/Yê°€ ê¸°ì¤€)
        selectStartScreenPos = { x: pos.x, y: pos.y }; 
        
        // ë°•ìŠ¤ ì´ˆê¸°í™”
        selectBox.style.display = 'block'; // ì¼ë‹¨ blockìœ¼ë¡œ ì„¤ì •í•˜ë˜ í¬ê¸°ë¥¼ 0ìœ¼ë¡œ
        selectBox.style.width = '0px';
        selectBox.style.height = '0px';
        selectBox.style.left = pos.x + 'px';
        selectBox.style.top = pos.y + 'px';

        selectedIds.clear();
        selectionType = null;
        document.getElementById('detail-panel').classList.remove('active');
        render();
        
    } else {
        // 5. ì¼ë°˜ í´ë¦­/ë“œë˜ê·¸
        if (ne) {
            e.preventDefault();
            processTap(ne.id, 'node', wx, wy);
        } else if (le) {
            e.preventDefault();
            const connId = le.dataset.id;
            
            document.getElementById('detail-panel').classList.remove('active');
            document.activeElement.blur();

            selectedIds.clear();
            selectedIds.add(connId);
            selectionType = 'connection';
            connectSourceId = null;
            render(); 
        } else {
            // ë¹ˆ ê³µê°„ í´ë¦­ -> ìº”ë²„ìŠ¤ ë“œë˜ê·¸
            isDragging = true;
            dragType = 'canvas';
            lastPos = pos;
            if (selectedIds.size > 0 || document.getElementById('detail-panel').classList.contains('active')) {
                selectedIds.clear();
                selectionType = null;
                connectSourceId = null;
                closePanel();
            }
        }
    }
}

function handleMove(e) {
    // ê¸°ë³¸ ì´ë²¤íŠ¸ ë°©ì§€ (ìŠ¤í¬ë¡¤ ë“±) ë° ì´ë²¤íŠ¸ ê°ì²´ ì €ì¥
    e.preventDefault();
    lastMoveEvent = e;

    // ì´ë¯¸ í”„ë ˆì„ ì˜ˆì•½ì´ ë˜ì–´ìˆë‹¤ë©´ ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
    if (!isTicking) {
        window.requestAnimationFrame(() => {
            if (lastMoveEvent) {
                performDrag(lastMoveEvent);
            }
            isTicking = false;
        });
        isTicking = true;
    }
}

function performDrag(e) {
    // 1. í•€ì¹˜ ì¤Œ (ëª¨ë°”ì¼)
    if (e.touches && e.touches.length === 2 && initialPinchDist > 0) {
        const d = getPinchDist(e);
        const c = getPinchCenter(e);
        const ns = Math.min(Math.max(0.2, initialScale * (d / initialPinchDist)), 5);
        const wcx = (initialPinchCenter.x - initialPan.x) / initialScale;
        const wcy = (initialPinchCenter.y - initialPan.y) / initialScale;
        panX = c.x - (wcx * ns);
        panY = c.y - (wcy * ns);
        scale = ns;
        updateTransform();
        return;
    }

    if (!isDragging && dragType !== 'box-select') return;
    
    const pos = getPos(e);

    // 2. ìº”ë²„ìŠ¤ íŒ¨ë‹
    if (dragType === 'canvas') {
        if (!isDragging) return; 
        panX += pos.x - lastPos.x;
        panY += pos.y - lastPos.y;
        lastPos = pos;
        updateTransform();
    } 
    // 3. ë°•ìŠ¤ ì„ íƒ
    else if (dragType === 'box-select') {
        // ë§ˆìš°ìŠ¤ í˜„ì¬ í™”ë©´ ì¢Œí‘œ
        const currentX = pos.x;
        const currentY = pos.y;

        // ì‹œì‘ì ê³¼ í˜„ì¬ì  ì‚¬ì´ì˜ ìµœì†Œê°’(Left/Top)ê³¼ ê±°ë¦¬(Width/Height) ê³„ì‚°
        const minX = Math.min(currentX, selectStartScreenPos.x);
        const minY = Math.min(currentY, selectStartScreenPos.y);
        const width = Math.abs(currentX - selectStartScreenPos.x);
        const height = Math.abs(currentY - selectStartScreenPos.y);
        
        // ë“œë˜ê·¸ ìƒíƒœ í™•ì • ë° ë°•ìŠ¤ ì—…ë°ì´íŠ¸
        if (width > 2 || height > 2) { // ë¯¼ê°ë„ ì•½ê°„ ì™„í™” (5 -> 2)
            isDragging = true; 
            selectBox.style.display = 'block';
            selectBox.style.transform = `translate(${minX}px, ${minY}px)`; // GPU ê°€ì† í™œìš©
            selectBox.style.left = '0px'; // transformì„ ì“°ë¯€ë¡œ 0ìœ¼ë¡œ ê³ ì •
            selectBox.style.top = '0px';
            selectBox.style.width = width + 'px';
            selectBox.style.height = height + 'px';
        }
    }
    // 4. [ìˆ˜ì •ë¨] ê·¸ë£¹ ì´ë™ (ìƒëŒ€ ì¢Œí‘œ ìŠ¤ëƒ… ì ìš©)
    else if (dragType === 'group-move') {
        if (!isDragging) return;

        const wx = (pos.x - panX) / scale;
        const wy = (pos.y - panY) / scale;
        
        const g = groups.find(x => x.id === dragId);
        if (g) {
            // ë§ˆìš°ìŠ¤ê°€ ì‹œì‘ì ì—ì„œ ì–¼ë§ˆë‚˜ ì›€ì§ì˜€ëŠ”ì§€ ê³„ì‚° (ì „ì²´ ì´ë™ ê±°ë¦¬)
            // dragOffset.xëŠ” startGroupDragì—ì„œ ì €ì¥í•œ 'í´ë¦­ ì‹œì‘ ì‹œì˜ ë§ˆìš°ìŠ¤ ì›”ë“œ ì¢Œí‘œ'ì—¬ì•¼ í•¨
            const mouseDx = wx - dragOffset.x;
            const mouseDy = wy - dragOffset.y;

            // ì´ë™ ê±°ë¦¬ë¥¼ ê·¸ë¦¬ë“œ ë‹¨ìœ„ë¡œ ìŠ¤ëƒ… (200px ë‹¨ìœ„ë¡œ ëŠì–´ì§)
            const snapX = GRID_X; // 200
            const snapY = GRID_Y; // 140

            const snappedDx = Math.round(mouseDx / snapX) * snapX;
            const snappedDy = Math.round(mouseDy / snapY) * snapY;

            // [í•µì‹¬] ì´ˆê¸° ê·¸ë£¹ ìœ„ì¹˜(initX)ì— ìŠ¤ëƒ…ëœ ì´ë™ëŸ‰(snappedDx)ì„ ë”í•¨
            // ì´ë ‡ê²Œ í•˜ë©´ ì´ˆê¸° ìƒì„± ì‹œì˜ ë¯¸ì„¸í•œ ì˜¤í”„ì…‹(ì—¬ë°±)ì´ ìœ ì§€ëœ ì±„ë¡œ ì´ë™í•¨
            const newX = dragOffset.initX + snappedDx;
            const newY = dragOffset.initY + snappedDy;

            // í˜„ì¬ ìœ„ì¹˜ì™€ ë¹„êµí•˜ì—¬ ë³€í™”ê°€ ìˆì„ ë•Œë§Œ ì—…ë°ì´íŠ¸
            if (g.x !== newX || g.y !== newY) {
                const deltaX = newX - g.x;
                const deltaY = newY - g.y;

                g.x = newX;
                g.y = newY;

                // [ë…¸ë“œ ë™ê¸°í™”] ê·¸ë£¹ì´ ì ‘í˜€ìˆì„ ë•Œë§Œ ë‚´ë¶€ ë…¸ë“œ ì´ë™
                if (g.collapsed && window.draggedGroupNodes) {
                    window.draggedGroupNodes.forEach(nid => {
                        const n = nodes.find(node => node.id === nid);
                        if (n) {
                            n.x += deltaX;
                            n.y += deltaY;
                        }
                    });

                    // ì—°ê²°ì„  ê°±ì‹  (ì ‘íŒ ê·¸ë£¹ ê´€ë ¨)
                    if (typeof renderConnections === 'function') {
                        const hiddenNodeIds = new Set();
                        groups.forEach(grp => {
                            if (grp.collapsed) {
                                nodes.forEach(n => {
                                    const cx = n.x + NODE_W/2, cy = n.y + NODE_H/2;
                                    if (cx >= grp.x && cx <= grp.x + grp.w && cy >= grp.y && cy <= grp.y + grp.h) {
                                        hiddenNodeIds.add(n.id);
                                    }
                                });
                            }
                        });
                        renderConnections(hiddenNodeIds);
                    }
                }

                // DOM ì—…ë°ì´íŠ¸
                const el = document.getElementById(g.id);
                if (el) {
                    el.style.left = g.x + 'px';
                    el.style.top = g.y + 'px';
                }
            }
        }
    }
    // 5. ê·¸ë£¹ í¬ê¸° ì¡°ì ˆ
    else if (dragType === 'group-resize') {
        if (!isDragging) return;

        const wx = (pos.x - panX) / scale;
        const wy = (pos.y - panY) / scale;
        
        const g = groups.find(x => x.id === dragId);
        if (g) {
            const dx = wx - dragOffset.x;
            const dy = wy - dragOffset.y;
            
            let nw = dragOffset.initW + dx;
            let nh = dragOffset.initH + dy;
            
            // í¬ê¸° ì¡°ì ˆì€ 20px ë‹¨ìœ„ ìœ ì§€ (ë¶€ë“œëŸ¬ìš´ ì¡°ì ˆ)
            const GROUP_SNAP = 20;
            
            if (nw < GROUP_SNAP * 2) nw = GROUP_SNAP * 2;
            if (nh < GROUP_SNAP * 2) nh = GROUP_SNAP * 2;
            
            g.w = Math.round(nw / GROUP_SNAP) * GROUP_SNAP;
            g.h = Math.round(nh / GROUP_SNAP) * GROUP_SNAP;
            
            const el = document.getElementById(g.id);
            if (el) {
                el.style.width = g.w + 'px';
                el.style.height = g.h + 'px';
            }
        }
    }
    // 6. ë…¸ë“œ ë“œë˜ê·¸
    else {
        if (!isDragging) return;

        const item = nodes.find(n => n.id === dragId);
        if (!item) return; 

        const wx = (pos.x - panX) / scale;
        const wy = (pos.y - panY) / scale;
        
        let tx = wx - dragOffset.x;
        let ty = wy - dragOffset.y;

        const c = Math.round((tx - START_X) / GRID_X);
        const r = Math.round((ty - START_Y) / GRID_Y);
        tx = START_X + (c * GRID_X);
        ty = START_Y + (r * GRID_Y);
        tx += (GRID_X / 2) - (NODE_W / 2);

        const dx = tx - item.x;
        const dy = ty - item.y;
        
        if (dx === 0 && dy === 0) return;

        selectedIds.forEach(id => {
            const obj = nodes.find(n => n.id === id);
            if (obj) {
                obj.x += dx;
                obj.y += dy;
                const el = document.getElementById(id);
                if (el) {
                    el.style.left = obj.x + 'px';
                    el.style.top = obj.y + 'px';
                }
            }
        });

        if (typeof updateRelatedConnections === 'function') {
            updateRelatedConnections();
        }
    }
}

        function handleEnd(e) {
    if (dragType === 'box-select') {
        // 1. ë“œë˜ê·¸ ëì (í˜„ì¬ ë§ˆìš°ìŠ¤ ìœ„ì¹˜) ê°€ì ¸ì˜¤ê¸°
        const pos = getPos(e); 
        
        // 2. í™”ë©´ìƒì—ì„œì˜ ë°•ìŠ¤ ì˜ì—­ ê³„ì‚° (ì‹œì‘ì  vs ëì )
        // selectStartScreenPosëŠ” handleStartì—ì„œ ì €ì¥í•œ ê°’ì…ë‹ˆë‹¤.
        const screenLeft = Math.min(selectStartScreenPos.x, pos.x);
        const screenTop = Math.min(selectStartScreenPos.y, pos.y);
        const screenRight = Math.max(selectStartScreenPos.x, pos.x);
        const screenBottom = Math.max(selectStartScreenPos.y, pos.y);
        
        // ë“œë˜ê·¸ ê±°ë¦¬ê°€ ë„ˆë¬´ ì§§ìœ¼ë©´(ë‹¨ìˆœ í´ë¦­ ë“±) ë¬´ì‹œ (5px ë¯¸ë§Œ)
        if (Math.abs(screenRight - screenLeft) > 5 || Math.abs(screenBottom - screenTop) > 5) {
            
            // 3. [í•µì‹¬] í™”ë©´ ì¢Œí‘œ -> ì›”ë“œ ì¢Œí‘œ(Zoom/Pan ì ìš©) ë³€í™˜
            // ê³µì‹: (í™”ë©´ì¢Œí‘œ - ì´ë™ê°’) / í™•ëŒ€ë°°ìœ¨
            const worldLeft = (screenLeft - panX) / scale;
            const worldTop = (screenTop - panY) / scale;
            const worldRight = (screenRight - panX) / scale;
            const worldBottom = (screenBottom - panY) / scale;

            selectedIds.clear();
            selectionType = 'node';

            // 4. ë…¸ë“œì™€ì˜ ì¶©ëŒ ê²€ì‚¬ (AABB ì¶©ëŒ ì•Œê³ ë¦¬ì¦˜)
            nodes.forEach(n => {
                // ë…¸ë“œì˜ ì›”ë“œ ì¢Œí‘œ ì˜ì—­
                const nLeft = n.x;
                const nRight = n.x + NODE_W;
                const nTop = n.y;
                const nBottom = n.y + NODE_H;

                // ë‘ ì‚¬ê°í˜•ì´ ê²¹ì¹˜ëŠ”ì§€ í™•ì¸
                if (worldLeft < nRight && worldRight > nLeft &&
                    worldTop < nBottom && worldBottom > nTop) {
                    selectedIds.add(n.id);
                }
            });

            if (selectedIds.size === 0) selectionType = null;
            render();
        }

        // 5. ë°•ìŠ¤ ìˆ¨ê¸°ê¸° ë° ì´ˆê¸°í™”
        selectBox.style.display = 'none';
        selectBox.style.width = '0px';
        selectBox.style.height = '0px';
        selectBox.style.transform = 'none'; // transform ì´ˆê¸°í™” ì¤‘ìš”
        
    } 
    else if (dragType === 'node' || dragType === 'group-move' || dragType === 'group-resize') {
        document.querySelectorAll('.dragging').forEach(e => e.classList.remove('dragging'));
        pushHistory();
    }

    isDragging = false;
    dragType = null;
    initialPinchDist = 0;
}

        function startLinkMode(e, id) {
            e.stopPropagation(); 
            e.preventDefault();
            connectSourceId = id;
            showToast("ì—°ê²°í•  ëŒ€ìƒì„ í„°ì¹˜í•˜ì„¸ìš”");
            render();
        }

        function completeLink(targetId) {
            if (!connectSourceId) return;
            if (connectSourceId === targetId) {
                showToast("ìê¸° ìì‹ ê³¼ëŠ” ì—°ê²° ë¶ˆê°€");
                connectSourceId = null;
                render();
                return;
            }
            
            if (connections.some(c => c.from === connectSourceId && c.to === targetId)) {
                showToast("ì´ë¯¸ ì—°ê²°ë˜ì–´ ìˆìŠµë‹ˆë‹¤");
            } else {
                connections.push({
                    id: 'conn_' + Date.now(),
                    from: connectSourceId,
                    to: targetId
                });
                pushHistory();
                showToast("ì—°ê²°ë¨!");
            }
            
            connectSourceId = null;
            render();
        }

        function deleteNodeDirect(e, id) {
            e.stopPropagation();
            e.preventDefault();
            openCustomModal("ì´ ì¥ë©´(Node)ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?", [
                { 
                    text: "ì‚­ì œ", 
                    class: "btn btn-danger", 
                    action: () => { 
                        executeDeleteNode(id); 
                        closeModal(); 
                    } 
                },
                { 
                    text: "ì·¨ì†Œ", 
                    class: "btn", 
                    action: closeModal 
                }
            ]);
        }

        function deleteConnectionDirect(e, id) {
            e.stopPropagation();
            e.preventDefault();
            openCustomModal("ì´ ì—°ê²°(Link)ì„ ëŠìœ¼ì‹œê² ìŠµë‹ˆê¹Œ?", [
                { 
                    text: "ëŠê¸°", 
                    class: "btn btn-danger", 
                    action: () => { 
                        executeDeleteConnection(id); 
                        closeModal(); 
                    } 
                },
                { 
                    text: "ì·¨ì†Œ", 
                    class: "btn", 
                    action: closeModal 
                }
            ]);
        }

        function executeDeleteNode(id) {
            nodes = nodes.filter(n => n.id !== id);
            connections = connections.filter(c => c.from !== id && c.to !== id);
            selectedIds.clear();
            selectionType = null;
            closePanel(); 
            render();
            pushHistory();
            showToast("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
        }

        function executeDeleteConnection(id) {
            connections = connections.filter(c => c.id !== id);
            selectedIds.clear();
            selectionType = null;
            render();
            pushHistory();
            showToast("ì—°ê²°ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
        }

        function updateRelatedConnections() {
    // ìºì‹±ëœ ë°°ì—´ë§Œ ìˆœíšŒ (querySelector ì œê±°)
    cachedRelatedLinks.forEach(item => {
        const { conn, fromNode, toNode, pathEl, hitEl } = item;
        
        // ì¢Œí‘œ ê³„ì‚° (ê¸°ì¡´ ë¡œì§ í•¨ìˆ˜ í™œìš©)
        const dStr = calculatePathString(fromNode, toNode, conn);
        
        // DOM ì—…ë°ì´íŠ¸
        if (hitEl) hitEl.setAttribute("d", dStr);
        if (pathEl) pathEl.setAttribute("d", dStr);
    });
}

        function calculatePathString(f, t, c) {
    const currentH = getCurrentNodeHeight(); // [ì‹ ê·œ]

    const isSameRow = Math.abs(f.y - t.y) < currentH / 2; // [ìˆ˜ì •]
    let dStr = "";

    if (isSameRow) {
        const fcy = f.y + currentH / 2; // [ìˆ˜ì •]
        const tcy = t.y + currentH / 2; // [ìˆ˜ì •]
        if (f.x < t.x) {
            const sx = f.x + NODE_W, ex = t.x, mx = (sx + ex) / 2;
            dStr = `M ${sx} ${fcy} L ${mx} ${fcy} L ${mx} ${tcy} L ${ex} ${tcy}`;
        } else {
            const sx = f.x, ex = t.x + NODE_W, mx = (sx + ex) / 2;
            dStr = `M ${sx} ${fcy} L ${mx} ${fcy} L ${mx} ${tcy} L ${ex} ${tcy}`;
        }
    } else {
        const rev = t.y < f.y;
        const sy = rev ? f.y : f.y + currentH; // [ìˆ˜ì •]
        const ey = rev ? t.y + currentH : t.y; // [ìˆ˜ì •]
        const sx = getSmartPortX(f, t, true, c);
        const ex = getSmartPortX(t, f, false, c);

        if (Math.abs(sx - ex) < 2) {
            dStr = `M ${sx} ${sy} L ${ex} ${ey}`;
        } else {
            const my = sy + (ey - sy) / 2;
            dStr = `M ${sx} ${sy} L ${sx} ${my} L ${ex} ${my} L ${ex} ${ey}`;
        }
    }
    return dStr;
}

        function handleWheel(e) { e.preventDefault(); const d=-e.deltaY*0.001; const ns=Math.min(Math.max(0.2,scale+d),5); const mx=e.clientX; const my=e.clientY; const wx=(mx-panX)/scale; const wy=(my-panY)/scale; panX=mx-(wx*ns); panY=my-(wy*ns); scale=ns; updateTransform(); }
        function updateTransform() {
    world.style.transform = `translate(${panX}px, ${panY}px) scale(${scale})`;
    
    const newLodMode = scale < 0.6;

    if (newLodMode !== isLodMode) {
        isLodMode = newLodMode;
        
        if (isLodMode) {
            world.classList.add('world-zoomed-out');
        } else {
            world.classList.remove('world-zoomed-out');
        }
        
        // [í•µì‹¬ ìˆ˜ì •] LOD ë³€ê²½ìœ¼ë¡œ ë‹¤ì‹œ ê·¸ë¦´ ë•Œ, í˜„ì¬ ìˆ¨ê²¨ì§„ ë…¸ë“œ ìƒíƒœë¥¼ ê³„ì‚°í•´ì„œ ì „ë‹¬í•´ì•¼ í•¨
        if (typeof renderConnections === 'function') {
            const hiddenNodeIds = getHiddenNodeIds(); // í˜„ì¬ ìƒíƒœ ê³„ì‚°
            renderConnections(hiddenNodeIds);
        }
    }

    if (document.getElementById('minimap').style.display === 'block') updateMinimap();
}
        function processTap(id,type,wx,wy) { const now=Date.now(); if(selectedIds.has(id)&&selectedIds.size===1&&now-lastTapTime<300)openPanel(); else { if(!selectedIds.has(id)){selectedIds.clear(); selectedIds.add(id); selectionType=type; render();} startDrag(id,type,wx,wy); } lastTapTime=now; }
function startDrag(id, type, wx, wy) {
    isDragging = true;
    dragType = type;
    dragId = id;
    
    const item = nodes.find(n => n.id === id);
    if (item) {
        dragOffset = { x: wx - item.x, y: wy - item.y };
        
        // [ìµœì í™”] ë“œë˜ê·¸ ì‹œì‘ ì‹œì ì— ê´€ë ¨ ì—°ê²°ì„  DOM ë¯¸ë¦¬ ì°¾ê¸°
        cachedRelatedLinks = [];
        
        // í˜„ì¬ ì„ íƒëœ ë…¸ë“œë“¤(ë‹¤ì¤‘ ì„ íƒ í¬í•¨)ê³¼ ê´€ë ¨ëœ ëª¨ë“  ì—°ê²°ì„  ì°¾ê¸°
        const activeNodeIds = new Set(selectedIds);
        if(!activeNodeIds.has(id)) activeNodeIds.add(id);

        connections.forEach(c => {
            if (activeNodeIds.has(c.from) || activeNodeIds.has(c.to)) {
                const pathEl = document.querySelector(`.link[data-id="${c.id}"]`); // ì£¼ì˜: renderConnectionsì—ì„œ .linkì—ë„ data-id í•„ìš”
                const hitEl = document.querySelector(`.link-hit[data-id="${c.id}"]`);
                if (hitEl) { // hitPathëŠ” í™•ì‹¤íˆ data-idê°€ ìˆìŒ
                    // pathElì„ ì°¾ê¸° ìœ„í•´ hitElì˜ ì´ì „ í˜•ì œë¥¼ ì°¾ê±°ë‚˜, renderConnections ìˆ˜ì • í•„ìš”
                    // ê°€ì¥ ì‰¬ìš´ ë°©ë²•: hitEl.previousElementSiblingì´ visible pathì„
                    cachedRelatedLinks.push({
                        conn: c,
                        fromNode: nodes.find(n => n.id === c.from),
                        toNode: nodes.find(n => n.id === c.to),
                        pathEl: hitEl.previousElementSibling,
                        hitEl: hitEl
                    });
                }
            }
        });

        // ë“œë˜ê·¸ ìŠ¤íƒ€ì¼ ì ìš©
        selectedIds.forEach(sid => { document.getElementById(sid)?.classList.add('dragging'); });
    }
}
        function getPortOffset(node,connId,isOutput) { const related=connections.filter(c=>isOutput?c.from===node.id:c.to===node.id); related.sort((a,b)=>{const nA=nodes.find(n=>n.id===(isOutput?a.to:a.from)); const nB=nodes.find(n=>n.id===(isOutput?b.to:b.from)); return nA.x-nB.x;}); const count=related.length; const index=related.findIndex(c=>c.id===connId); if(count<=1)return 0; return -((count-1)*10)/2+(index*10); }
        function getSmartPortX(node,targetNode,isOutput,currentConn) { const center=node.x+NODE_W/2; if(Math.abs(node.x-targetNode.x)<5)return center; let dir='center'; if(targetNode.x>node.x+THRESHOLD)dir='right'; if(targetNode.x<node.x-THRESHOLD)dir='left'; const offset=getPortOffset(node,currentConn.id,isOutput); if(dir==='center')return center+offset; else if(dir==='right')return (node.x+NODE_W*0.75)+offset; else return (node.x+NODE_W*0.25)+offset; }
        
function renderConnections(hiddenNodeIds = new Set()) {
    svgLayer.innerHTML = '';
    document.querySelectorAll('.connection-actions').forEach(el => el.remove());

    const currentH = getCurrentNodeHeight(); 

    connections.forEach((c, i) => {
        // 1. ì–‘ìª½ ëª¨ë‘ ìˆ¨ê²¨ì¡Œìœ¼ë©´ ê·¸ë¦¬ì§€ ì•ŠìŒ (ê·¸ë£¹ ë‚´ë¶€ë¼ë¦¬ì˜ ì—°ê²°)
        const fromHidden = hiddenNodeIds.has(c.from);
        const toHidden = hiddenNodeIds.has(c.to);
        
        if (fromHidden && toHidden) return;

        // 2. ë…¸ë“œ ê°ì²´ ì°¾ê¸°
        let f = nodes.find(n => n.id === c.from);
        let t = nodes.find(n => n.id === c.to);

        // [í•µì‹¬] í•œìª½ë§Œ ìˆ¨ê²¨ì§„ ê²½ìš°, í•´ë‹¹ ë…¸ë“œê°€ ì†í•œ 'ì ‘íŒ ê·¸ë£¹'ì„ ì°¾ì•„ ì¢Œí‘œ ëŒ€ë¦¬ìë¡œ ì‚¬ìš©
        if (fromHidden) {
            const group = findCollapsedGroupOfNode(c.from);
            if (group) {
                // ê·¸ë£¹ì„ ê°€ìƒì˜ ë…¸ë“œì²˜ëŸ¼ ì·¨ê¸‰ (ì¢Œí‘œì™€ í¬ê¸° ë³€í™˜)
                f = { 
                    x: group.x, 
                    y: group.y, 
                    w: group.w, 
                    h: 40 // ì ‘íŒ í—¤ë” ë†’ì´
                }; 
            }
        }
        
        if (toHidden) {
            const group = findCollapsedGroupOfNode(c.to);
            if (group) {
                t = { 
                    x: group.x, 
                    y: group.y, 
                    w: group.w, 
                    h: 40 
                };
            }
        }

        if (f && t) {
            // ë„ˆë¹„/ë†’ì´ ê¸°ë³¸ê°’ ì²˜ë¦¬ (ì¼ë°˜ ë…¸ë“œëŠ” NODE_W, NODE_H ì‚¬ìš©)
            const fw = f.w || NODE_W;
            const fh = f.h || currentH;
            const tw = t.w || NODE_W;
            const th = t.h || currentH;

            const isSel = selectedIds.has(c.id);
            const p = document.createElementNS("http://www.w3.org/2000/svg", "path");
            p.classList.add("link");
            if (isSel) p.classList.add("selected");
            p.style.stroke = isSel ? '' : LINE_COLORS[i % LINE_COLORS.length]; 
            p.dataset.id = c.id; // [ì¤‘ìš”] ë“œë˜ê·¸ ì‹œ ì‹ë³„ìš©

            const hit = document.createElementNS("http://www.w3.org/2000/svg", "path");
            hit.classList.add("link-hit");
            hit.dataset.id = c.id;

            // [ìˆ˜ì •] ë†’ì´(th, fh)ë¥¼ ê³ ë ¤í•˜ì—¬ ì¤‘ì‹¬ì  ê³„ì‚°
            const isSameRow = Math.abs(f.y - t.y) < Math.max(fh, th) / 2;
            let dStr = "";
            let midX, midY;

            if (isSameRow) {
                const fcy = f.y + fh / 2;
                const tcy = t.y + th / 2;
                
                if (f.x < t.x) {
                    const sx = f.x + fw, ex = t.x, mx = (sx + ex) / 2;
                    dStr = `M ${sx} ${fcy} L ${mx} ${fcy} L ${mx} ${tcy} L ${ex} ${tcy}`;
                    midX = mx; midY = (fcy + tcy) / 2;
                } else {
                    const sx = f.x, ex = t.x + tw, mx = (sx + ex) / 2;
                    dStr = `M ${sx} ${fcy} L ${mx} ${fcy} L ${mx} ${tcy} L ${ex} ${tcy}`;
                    midX = mx; midY = (fcy + tcy) / 2;
                }
            } else {
                const rev = t.y < f.y;
                const sy = rev ? f.y : f.y + fh; 
                const ey = rev ? t.y + th : t.y; 
                
                // ê·¸ë£¹ì¼ ê²½ìš° í¬íŠ¸ ìœ„ì¹˜ ë³´ì • (ë‹¨ìˆœ ì¤‘ì•™ì´ë‚˜ ë¹„ë¡€ ìœ„ì¹˜ ì‚¬ìš©)
                const sx = (f.w) ? (f.x + fw/2) : getSmartPortX(f, t, true, c);
                const ex = (t.w) ? (t.x + tw/2) : getSmartPortX(t, f, false, c);

                if (Math.abs(sx - ex) < 2) {
                    dStr = `M ${sx} ${sy} L ${ex} ${ey}`;
                    midX = sx; midY = (sy + ey) / 2;
                } else {
                    const my = sy + (ey - sy) / 2;
                    dStr = `M ${sx} ${sy} L ${sx} ${my} L ${ex} ${my} L ${ex} ${ey}`;
                    midX = (sx + ex) / 2; midY = my;
                }
            }

            p.setAttribute("d", dStr);
            hit.setAttribute("d", dStr);
            svgLayer.appendChild(p);
            svgLayer.appendChild(hit);
            
            if (isSel) {
                const menu = document.createElement('div');
                menu.className = 'connection-actions';
                menu.style.left = midX + 'px';
                menu.style.top = midY + 'px';
                menu.innerHTML = `
                    <button class="action-btn delete" 
                        data-action="delete-conn" 
                        data-id="${c.id}" 
                        title="ì—°ê²° ì‚­ì œ">
                        ğŸ—‘ï¸
                    </button>
                `;
                nodesLayer.appendChild(menu);
            }
        }
    });
}

// [ì‹ ê·œ] í—¬í¼ í•¨ìˆ˜: íŠ¹ì • ë…¸ë“œê°€ ì†í•œ 'ì ‘íŒ ê·¸ë£¹' ì°¾ê¸°
function findCollapsedGroupOfNode(nodeId) {
    // 1. ë“œë˜ê·¸ ì¤‘ì¸ ê·¸ë£¹ì— ì†í•´ ìˆëŠ”ì§€ ìš°ì„  í™•ì¸ (ìºì‹œ í™œìš©)
    if (isDragging && dragType === 'group-move' && window.draggedGroupNodes) {
        if (window.draggedGroupNodes.includes(nodeId)) {
            // í˜„ì¬ ë“œë˜ê·¸ ì¤‘ì¸ ê·¸ë£¹ IDë¡œ ê°ì²´ ì°¾ì•„ ë°˜í™˜
            return groups.find(g => g.id === dragId);
        }
        // ë“œë˜ê·¸ ì¤‘ì¸ ë…¸ë“œ ëª©ë¡ì— ì—†ìœ¼ë©´, ë“œë˜ê·¸ ì¤‘ì¸ ê·¸ë£¹ì—ëŠ” ì ˆëŒ€ í¬í•¨ë˜ì§€ ì•Šì€ ê²ƒì„.
        // ì•„ë˜ ë£¨í”„ì—ì„œ ë“œë˜ê·¸ ì¤‘ì¸ ê·¸ë£¹ì€ ê²€ì‚¬ ëŒ€ìƒì—ì„œ ì œì™¸ë˜ê±°ë‚˜, ì¢Œí‘œê°€ ê²¹ì³ë„ ë¬´ì‹œí•´ì•¼ í•¨.
    }

    const n = nodes.find(x => x.id === nodeId);
    if (!n) return null;
    
    const center = { x: n.x + NODE_W/2, y: n.y + NODE_H/2 };
    
    for (const g of groups) {
        if (g.collapsed) {
            // [í•µì‹¬] ë§Œì•½ ì´ ê·¸ë£¹ì´ í˜„ì¬ ì´ë™ ì¤‘ì´ë¼ë©´, ì¢Œí‘œ ê²€ì‚¬ë¡œ ì°¾ì§€ ë§ ê²ƒ!
            // (ì´ë™ ì¤‘ì¸ ê·¸ë£¹ ë‚´ë¶€ ë…¸ë“œëŠ” ì´ë¯¸ ìœ„ 1ë²ˆ ë¡œì§ì—ì„œ ê±¸ëŸ¬ì¡ŒìŒ. 
            //  ì—¬ê¸°ê¹Œì§€ ì™”ë‹¤ëŠ” ê±´ ì´ë™ ì¤‘ì¸ ê·¸ë£¹ì—ëŠ” ì•ˆ ì†í•œë‹¤ëŠ” ëœ»)
            if (isDragging && dragType === 'group-move' && dragId === g.id) {
                continue;
            }

            if (center.x >= g.x && center.x <= g.x + g.w && 
                center.y >= g.y && center.y <= g.y + g.h) {
                return g;
            }
        }
    }
    return null;
}
        function createNode(x,y,t,type,d) { const id='n_'+Date.now()+Math.floor(Math.random()*999); nodes.push({id,x,y,title:t,type,desc:d}); return id; }
        function addNode(type) {
            if (selectedIds.size !== 1 || selectionType !== 'node') {
                showToast("ë¶€ëª¨ ë…¸ë“œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”");
                return;
            }
            const p = nodes.find(n => n.id === Array.from(selectedIds)[0]);
            
            const pc = Math.round((p.x - START_X - (GRID_X / 2) + (NODE_W / 2)) / GRID_X);
            const pr = Math.round((p.y - START_Y) / GRID_Y);
            let c = pc, r = pr + 1;
            while (nodes.some(n => {
                const nc = Math.round((n.x - START_X - (GRID_X / 2) + (NODE_W / 2)) / GRID_X);
                const nr = Math.round((n.y - START_Y) / GRID_Y);
                return nc === c && nr === r;
            })) c++;
            const nx = START_X + (c * GRID_X) + (GRID_X / 2) - (NODE_W / 2);
            const ny = START_Y + (r * GRID_Y);

            let title = '';
            if(type === 'choice') title = 'ì„ íƒì§€';
            else title = `ì¥ë©´ ${sceneCounter++}`;

            const nid = createNode(nx, ny, title, type, '');
            
            connections.push({ id: 'conn_' + Date.now(), from: p.id, to: nid });
            
            selectedIds.clear();
            selectedIds.add(nid);
            selectionType = 'node';
            render();
            pushHistory();
        }
        function addNodeWithSelector() {
            // ê¸°ë³¸ì ìœ¼ë¡œ ì²« ë²ˆì§¸ íƒ€ì…(nodeTypes[0])ìœ¼ë¡œ ìƒì„±í•©ë‹ˆë‹¤.
            // ë§Œì•½ íƒ€ì…ì´ í•˜ë‚˜ë„ ì—†ë‹¤ë©´ ì•ˆì „ì¥ì¹˜ë¡œ 'normal' ì‚¬ìš©
            const defaultTypeId = (nodeTypes.length > 0) ? nodeTypes[0].id : 'normal';
            addNode(defaultTypeId);
        }
        function addGroup() {
            const id = 'g_' + Date.now();
            let gx, gy, gw, gh;
            
            // [ìˆ˜ì •] ê·¸ë¦¬ë“œ ìŠ¤ëƒ… ë‹¨ìœ„ ì •ì˜ (20px)
            // ì´ë™í•  ë•Œì™€ ë™ì¼í•œ ë‹¨ìœ„ë¥¼ ì‚¬ìš©í•˜ì—¬ ìœ„í™”ê°ì„ ì—†ì•±ë‹ˆë‹¤.
            const SNAP = 20; 
            const PADDING = 20; // ë…¸ë“œì™€ì˜ ì—¬ë°±

            if (selectionType === 'node' && selectedIds.size > 0) {
                let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
                
                selectedIds.forEach(nid => {
                    const n = nodes.find(node => node.id === nid);
                    if (n) {
                        minX = Math.min(minX, n.x);
                        minY = Math.min(minY, n.y);
                        maxX = Math.max(maxX, n.x + NODE_W);
                        maxY = Math.max(maxY, n.y + NODE_H);
                    }
                });

                // [ì¤‘ìš” ìˆ˜ì •] ì¢Œí‘œ ê³„ì‚° ë°©ì‹ ë³€ê²½
                // ì‹œì‘ì (Top-Left)ì€ ì—¬ë°±ì„ ë¹¼ê³  'ë‚´ë¦¼(floor)'í•˜ì—¬ ë°”ê¹¥ìœ¼ë¡œ í™•ì¥
                // ëì (Bottom-Right)ì€ ì—¬ë°±ì„ ë”í•˜ê³  'ì˜¬ë¦¼(ceil)'í•˜ì—¬ ë°”ê¹¥ìœ¼ë¡œ í™•ì¥
                
                // 1. í—¤ë” ë†’ì´(30px) ê³ ë ¤í•˜ì—¬ Yì¶• ì‹œì‘ì  ìœ„ë¡œ ì˜¬ë¦¼
                const rawX = minX - 10;
                const rawY = minY - 10 - 30;
                const rawRight = maxX + 10;
                const rawBottom = maxY + 10;

                // 2. ê·¸ë¦¬ë“œ ìŠ¤ëƒ… ì ìš© (ë°”ê¹¥ìª½ìœ¼ë¡œ)
                gx = Math.floor(rawX / SNAP) * SNAP;
                gy = Math.floor(rawY / SNAP) * SNAP;
                
                const snapRight = Math.ceil(rawRight / SNAP) * SNAP;
                const snapBottom = Math.ceil(rawBottom / SNAP) * SNAP;

                gw = snapRight - gx;
                gh = snapBottom - gy;

            } else {
                // ì„ íƒëœ ë…¸ë“œê°€ ì—†ì„ ë•Œ: í™”ë©´ ì¤‘ì•™ì— ê¸°ë³¸ í¬ê¸° ìƒì„±
                const cx = (-panX + window.innerWidth / 2) / scale;
                const cy = (-panY + window.innerHeight / 2) / scale;
                
                gx = Math.floor(cx / SNAP) * SNAP;
                gy = Math.floor(cy / SNAP) * SNAP;
                gw = 300; // ê¸°ë³¸ ë„ˆë¹„
                gh = 300; // ê¸°ë³¸ ë†’ì´
            }
            
            groups.push({
                id: id,
                x: gx, y: gy, w: gw, h: gh,
                title: 'New Group',
                color: '#00f0ff'
            });
            
            selectedIds.clear();
            selectedIds.add(id);
            selectionType = 'group';
            
            render();
            pushHistory();
            showToast("ê·¸ë£¹ ìƒì„±ë¨");
            
            // ìƒì„± ì§í›„ ì†ì„±ì°½ ì—´ê¸°
            openPanel();
        }

function render() {
    nodesLayer.innerHTML = '';
    sepLayer.innerHTML = ''; 

    // 1. ìˆ¨ê²¨ì§ˆ ë…¸ë“œ ì‹ë³„
    const hiddenNodeIds = getHiddenNodeIds();

    // 2. ê·¸ë£¹ ë Œë”ë§
    groups.forEach(g => {
        const isSel = selectedIds.has(g.id);
        const color = g.color || '#00f0ff'; 
        const isCollapsed = g.collapsed === true;

        const div = document.createElement('div');
        div.className = `group-box ${isSel ? 'selected' : ''} ${isCollapsed ? 'collapsed' : ''}`;
        div.id = g.id;
        
        div.style.left = g.x + 'px';
        div.style.top = g.y + 'px';
        div.style.width = g.w + 'px';
        
        if (!isCollapsed) {
            div.style.height = g.h + 'px';
        }
        
        div.style.borderColor = color;
        
        let bgStyle = `background-color: ${color}80;`;
        let textStyle = 'color: #ffffff;';

        if (isSel) {
            div.style.backgroundColor = color + '1a';
            textStyle = `color: ${color};`; 
        }

        const toggleIcon = isCollapsed ? 'â–¶' : 'â–¼';
        
        div.innerHTML = `
            <div class="group-header" 
                 style="${bgStyle} ${textStyle}" 
                 data-action="group-drag" 
                 data-id="${g.id}">
                <span class="group-toggle-icon" 
                      onclick="toggleGroupCollapse(event, '${g.id}')"
                      ontouchstart="toggleGroupCollapse(event, '${g.id}')">
                    ${toggleIcon}
                </span> 
                ${g.title}
            </div>
            <div class="resize-handle"
                 data-action="group-resize"
                 data-id="${g.id}">
            </div>
        `;
        sepLayer.appendChild(div);
    });

    // 3. ë…¸ë“œ ë Œë”ë§ (ìˆ¨ê²¨ì§„ ë…¸ë“œ ìŠ¤í‚µ)
    nodes.forEach(n => {
        if (hiddenNodeIds.has(n.id)) return; 

        const s = selectedIds.has(n.id);
        const d = document.createElement('div');
        d.className = `node ${s ? 'selected' : ''}`;
        if (connectSourceId === n.id) d.classList.add('waiting-target');
        d.id = n.id;
        
        const typeObj = nodeTypes.find(t => t.id === n.type) || nodeTypes[0];
        const typeColor = typeObj.color;
        
        d.style.left = n.x + 'px';
        d.style.top = n.y + 'px';
        d.style.borderLeft = `4px solid ${typeColor}`;
        d.dataset.color = typeColor;
        
        // ìºë¦­í„° ìƒ‰ìƒ ë  ìƒì„±
        let charStripHtml = '';
        if (n.dialogues && n.dialogues.length > 0) {
            const uniqueChars = [...new Set(n.dialogues.map(dia => dia.charId).filter(id => id))];
            if (uniqueChars.length > 0) {
                charStripHtml = '<div class="node-char-strip">';
                uniqueChars.forEach(cid => {
                    const charObj = characters.find(c => c.id === cid);
                    if (charObj) {
                        charStripHtml += `<div class="char-color-indicator" style="background-color: ${charObj.color};"></div>`;
                    }
                });
                charStripHtml += '</div>';
            }
        }

        // HTML ë‚´ë¶€ êµ¬ì¡° ì¡°ë¦½
        let h = `<div class="node-header"><span class="node-title">${n.title}</span></div>`;
        
        // [ìˆ˜ì •ë¨] ì¡°ê±´(Req) í‘œì‹œ
        if (n.req) h += `<div class="logic-tag logic-req">IF: ${n.req}</div>`;
        
        // ë³¸ë¬¸ í…ìŠ¤íŠ¸ (ìš”ì•½ or ëŒ€ì‚¬)
        let mainText = '';
        if (n.summary && n.summary.trim() !== '') {
            mainText = n.summary;
        } else if (n.dialogues && n.dialogues.length > 0 && n.dialogues[0].text.trim() !== '') {
            mainText = n.dialogues[0].text;
        } else {
            mainText = 'ë‚´ìš© ì—†ìŒ';
        }
        h += `<div class="node-desc" style="color: #aaa; font-style: italic;">${mainText}</div>`;
        
        // [ìˆ˜ì •ë¨] ì—°ì‚°(Act) í‘œì‹œ ì½”ë“œ ì¶”ê°€ (ì´ ë¶€ë¶„ì´ ë¹ ì ¸ ìˆì—ˆìŠµë‹ˆë‹¤)
        if (n.act) h += `<div class="logic-tag logic-act">SET: ${n.act}</div>`;

        // ìƒ‰ìƒ ë  ì¶”ê°€
        h += charStripHtml;

        // ì•¡ì…˜ ë²„íŠ¼ ì¶”ê°€
        h += `
        <div class="node-actions">
            <button class="action-btn" data-action="link" data-id="${n.id}" title="ì—°ê²°">ğŸ”—</button>
            <button class="action-btn delete" data-action="delete-node" data-id="${n.id}" title="ì‚­ì œ">ğŸ—‘ï¸</button>
        </div>
        `;
        d.innerHTML = h;
        nodesLayer.appendChild(d);
    });

    // 4. ì—°ê²°ì„  ë Œë”ë§
    if(typeof renderConnections === 'function') renderConnections(hiddenNodeIds);
    
    updateTransform();
    if (document.getElementById('minimap').style.display === 'block') updateMinimap();
}

window.toggleGroupCollapse = (e, id) => {
    // í´ë¦­ ì´ë²¤íŠ¸ê°€ ë¶€ëª¨(í—¤ë” -> ê·¸ë£¹ë°•ìŠ¤)ë¡œ ì „íŒŒë˜ì–´ 'ê·¸ë£¹ ì„ íƒ'ì´ ë˜ëŠ” ê²ƒì„ ë°©ì§€
    if(e) {
        e.stopPropagation();
        e.preventDefault();
    }

    const g = groups.find(x => x.id === id);
    if (g) {
        g.collapsed = !g.collapsed;
        render(); 
        pushHistory(); 
    }
};

        function startGroupDrag(e, id) {
    e.stopPropagation(); 

    const now = Date.now();
    if (selectedIds.has(id) && selectedIds.size === 1 && (now - lastTapTime < 300)) {
        openPanel();
        isDragging = false; 
        return;
    }
    lastTapTime = now;

    if (!selectedIds.has(id)) {
        selectedIds.clear();
        selectedIds.add(id);
        selectionType = 'group';
        render();
    }
    
    const pos = getPos(e);
    const wx = (pos.x - panX) / scale;
    const wy = (pos.y - panY) / scale;
    
    isDragging = true;
    dragType = 'group-move';
    dragId = id;
    
    const g = groups.find(x => x.id === id);
    
    dragOffset = { 
        x: wx,      
        y: wy, 
        initX: g.x, 
        initY: g.y 
    };

    // [í•µì‹¬ ì¶”ê°€] ë“œë˜ê·¸ ì‹œì‘ ì‹œ, ê·¸ë£¹ ì˜ì—­ ë‚´ì— ìˆëŠ” ëª¨ë“  ë…¸ë“œ IDë¥¼ ìºì‹±
    // ì ‘íŒ ìƒíƒœ(collapsed)ì—¬ë„ g.hëŠ” (í¼ì³ì¡Œì„ ë•Œì˜) ì›ë˜ ë†’ì´ë¥¼ ìœ ì§€í•˜ê³  ìˆì–´ì•¼ í•¨.
    // ë§Œì•½ collapsed ìƒíƒœë¼ g.hê°€ ì‘ê²Œ ë³´ì¸ë‹¤ë©´, ë°ì´í„°ì—ëŠ” ì›ë˜ ë†’ì´ë¥¼ ë”°ë¡œ ì €ì¥í–ˆì–´ì•¼ í•¨.
    // í•˜ì§€ë§Œ í˜„ì¬ êµ¬ì¡°ìƒ g.hëŠ” ë°ì´í„° ì›ë³¸ì´ë¯€ë¡œ ë¯¿ê³  ì‚¬ìš©í•¨.
    
    window.draggedGroupNodes = [];
    nodes.forEach(n => {
        const cx = n.x + NODE_W/2;
        const cy = n.y + NODE_H/2;
        
        // ë…¸ë“œ ì¤‘ì‹¬ì ì´ ê·¸ë£¹ ì‚¬ê°í˜• ì•ˆì— ìˆìœ¼ë©´ 'í¬í•¨ëœ ë…¸ë“œ'ë¡œ ê°„ì£¼
        if (cx >= g.x && cx <= g.x + g.w && cy >= g.y && cy <= g.y + g.h) {
            window.draggedGroupNodes.push(n.id);
        }
    });
    
    if (document.getElementById('detail-panel').classList.contains('active')) {
        openPanel();
    }
}

        // ê·¸ë£¹ í¬ê¸° ì¡°ì ˆ ì‹œì‘
        function startGroupResize(e, id) {
            e.stopPropagation();
            selectedIds.clear();
            selectedIds.add(id);
            selectionType = 'group';
            render();

            const pos = getPos(e);
            const wx = (pos.x - panX) / scale;
            const wy = (pos.y - panY) / scale;

            isDragging = true;
            dragType = 'group-resize';
            dragId = id;
            
            const g = groups.find(x => x.id === id);
            // ì˜¤í”„ì…‹ì— í˜„ì¬ í¬ê¸°ì™€ ë§ˆìš°ìŠ¤ ìœ„ì¹˜ì˜ ì°¨ì´ë¥¼ ì €ì¥
            dragOffset = { x: wx, y: wy, initW: g.w, initH: g.h };
        }

        function updateMinimap() { 
            if (!nodes.length) return; 
            
            // ì „ì²´ ë²”ìœ„ ê³„ì‚°
            let minX=Infinity,maxX=-Infinity,minY=Infinity,maxY=-Infinity; 
            nodes.forEach(n=>{
                if(n.x<minX)minX=n.x;
                if(n.x+NODE_W>maxX)maxX=n.x+NODE_W;
                if(n.y<minY)minY=n.y;
                if(n.y+NODE_H>maxY)maxY=n.y+NODE_H;
            }); 
            
            // ì—¬ë°± ì¶”ê°€
            minX-=500; maxX+=500; minY-=500; maxY+=500; 
            
            const mW=maxX-minX, mH=maxY-minY; 
            minimapCanvas.width=200; 
            minimapCanvas.height=150; 
            const ctx=minimapCtx; 
            ctx.clearRect(0,0,200,150); 
            
            // ë¹„ìœ¨ ê³„ì‚°
            const r=Math.min(200/mW, 150/mH); 
            const offX=(200-mW*r)/2; 
            const offY=(150-mH*r)/2; 
            
            // ë…¸ë“œ ê·¸ë¦¬ê¸°
            nodes.forEach(n=>{
                // [ìˆ˜ì •] ì»¤ìŠ¤í…€ íƒ€ì… ìƒ‰ìƒ ì¡°íšŒ
                const typeObj = nodeTypes.find(t => t.id === n.type);
                // íƒ€ì…ì´ ì—†ê±°ë‚˜ ì‚­ì œë˜ì—ˆìœ¼ë©´ ê¸°ë³¸ í°ìƒ‰/íšŒìƒ‰ ì‚¬ìš©
                ctx.fillStyle = typeObj ? typeObj.color : '#888888'; 
                
                ctx.fillRect(offX+(n.x-minX)*r, offY+(n.y-minY)*r, NODE_W*r, NODE_H*r);
            }); 
            
            // ë·°í¬íŠ¸ í‘œì‹œ ì—…ë°ì´íŠ¸
            const vX=(-panX)/scale, vY=(-panY)/scale, vW=window.innerWidth/scale, vH=window.innerHeight/scale; 
            minimapViewport.style.left=(offX+(vX-minX)*r)+'px'; 
            minimapViewport.style.top=(offY+(vY-minY)*r)+'px'; 
            minimapViewport.style.width=(vW*r)+'px'; 
            minimapViewport.style.height=(vH*r)+'px'; 
            
            minimapCanvas.dataset.params = JSON.stringify({minX,minY,r,offX,offY}); 
        }
        function handleMinimapPan(e) { const p = JSON.parse(minimapCanvas.dataset.params); const rect = minimap.getBoundingClientRect(); const cx = e.clientX-rect.left, cy=e.clientY-rect.top; const wx = p.minX + (cx-p.offX)/p.r; const wy = p.minY + (cy-p.offY)/p.r; panX=window.innerWidth/2 - wx*scale; panY=window.innerHeight/2 - wy*scale; updateTransform(); }
        function copySelected() { if(selectedIds.size===0||selectionType!=='node')return; const cn=nodes.filter(n=>selectedIds.has(n.id)); const cc=connections.filter(c=>selectedIds.has(c.from)&&selectedIds.has(c.to)); clipboard={nodes:JSON.parse(JSON.stringify(cn)),connections:JSON.parse(JSON.stringify(cc))}; showToast(`${cn.length}ê°œ ë³µì‚¬`); }
        function pasteNodes() { if(!clipboard||!clipboard.nodes.length)return; selectedIds.clear(); selectionType='node'; const cx=(-panX+window.innerWidth/2)/scale, cy=(-panY+window.innerHeight/2)/scale, bx=clipboard.nodes[0].x, by=clipboard.nodes[0].y, map={}; clipboard.nodes.forEach(n=>{const nid='n_'+Date.now()+Math.random().toString(36).substr(2,5); map[n.id]=nid; const nn={...n, id:nid, x:Math.round((cx+n.x-bx)/GRID_X)*GRID_X, y:Math.round((cy+n.y-by)/GRID_Y)*GRID_Y}; nodes.push(nn); selectedIds.add(nid);}); clipboard.connections.forEach(c=>{connections.push({id:'conn_'+Date.now()+Math.random().toString(36).substr(2,5), from:map[c.from], to:map[c.to]});}); render(); pushHistory(); showToast("ë¶™ì—¬ë„£ê¸°"); }
        function showToast(m) { const t=document.getElementById('toast'); t.textContent=m; t.style.opacity=1; setTimeout(()=>t.style.opacity=0,2000); }
        function toggleSearch() { const b=document.getElementById('search-bar'); b.style.display=(b.style.display==='block')?'none':'block'; if(b.style.display==='block')document.getElementById('search-input').focus(); }
        function performSearch() { const q=document.getElementById('search-input').value.toLowerCase(); if(!q)return; searchResults=nodes.filter(n=>n.title.toLowerCase().includes(q)||n.desc.toLowerCase().includes(q)); searchIndex=-1; updateSearchUI(); if(searchResults.length>0)searchNext(); else showToast("ê²°ê³¼ ì—†ìŒ"); }
        function searchNext() { if(!searchResults.length)return; searchIndex=(searchIndex+1)%searchResults.length; focusNode(searchResults[searchIndex].id); updateSearchUI(); }
        function searchPrev() { if(!searchResults.length)return; searchIndex=(searchIndex-1+searchResults.length)%searchResults.length; focusNode(searchResults[searchIndex].id); updateSearchUI(); }
        function updateSearchUI() { document.getElementById('search-count').textContent = searchResults.length > 0 ? `${searchIndex+1}/${searchResults.length}` : "0/0"; }
        function focusNode(id) { const n=nodes.find(x=>x.id===id); if(n){selectedIds.clear(); selectedIds.add(id); selectionType='node'; panX=window.innerWidth/2-(n.x+NODE_W/2)*scale; panY=window.innerHeight/2-(n.y+NODE_H/2)*scale; updateTransform(); render();} }
        function fitToScreen() { if(!nodes.length){panX=0;panY=0;scale=1;return;} let mx=Infinity,Mx=-Infinity,my=Infinity,My=-Infinity; nodes.forEach(n=>{if(n.x<mx)mx=n.x;if(n.x+NODE_W>Mx)Mx=n.x+NODE_W;if(n.y<my)my=n.y;if(n.y+NODE_H>My)My=n.y+NODE_H;}); const cw=Mx-mx,ch=My-my,cx=mx+cw/2,cy=my+ch/2,sx=(window.innerWidth-100)/cw,sy=(window.innerHeight-100)/ch; scale=Math.min(Math.max(sx,sy),1); if(scale<0.2)scale=0.2; panX=window.innerWidth/2-(cx*scale); panY=window.innerHeight/2-(cy*scale); updateTransform(); }
        function autoArrange() { showToast("ì •ë ¬ ê¸°ëŠ¥ì€ ì´ì „ ë²„ì „ ì½”ë“œ ì°¸ì¡°"); }
        function updateNodeData() {
    if (selectionType !== 'node' || selectedIds.size !== 1) return;
    const n = nodes.find(x => x.id === Array.from(selectedIds)[0]);
    
    // ê¸°ë³¸ ì •ë³´ ì—…ë°ì´íŠ¸
    n.title = document.getElementById('input-title').value;
    n.type = document.getElementById('input-type').value;
    
    // [ìˆ˜ì •ë¨] input-descëŠ” HTMLì—ì„œ ì‚­ì œë˜ì—ˆìœ¼ë¯€ë¡œ ê°’ì„ ì½ì§€ ì•ŠìŠµë‹ˆë‹¤.
    // ì„¤ëª…(Description)ì€ ì´ì œ Dialogue/Summaryê°€ ëŒ€ì²´í•©ë‹ˆë‹¤.
    // n.desc = document.getElementById('input-desc').value; <--- ì´ ì¤„ì´ ì—ëŸ¬ì˜ ì›ì¸ì´ì—ˆìŠµë‹ˆë‹¤.
    
    // ì¡°ê±´/ì—°ì‚° ì—…ë°ì´íŠ¸ (hidden inputì—ì„œ ê°’ ê°€ì ¸ì˜¤ê¸°)
    n.req = document.getElementById('input-req').value;
    n.act = document.getElementById('input-act').value;
    
    render();
}

        // --- Visual Logic Builder Functions ---

// 1. ë¡œì§ í–‰(Row) UI ìƒì„± ë° ì¶”ê°€
function addLogicRow(type, data = { variable: '', op: '', value: '' }) {
    const container = document.getElementById(`${type}-container`);
    const div = document.createElement('div');
    div.className = 'logic-row-item';
    
    // ì—°ì‚°ì ì˜µì…˜ ì •ì˜
    let opsHtml = '';
    if (type === 'req') {
        const ops = ['==', '!=', '>=', '<=', '>', '<'];
        ops.forEach(op => opsHtml += `<option value="${op}" ${op===data.op?'selected':''}>${op}</option>`);
    } else {
        const ops = ['=', '+=', '-='];
        ops.forEach(op => opsHtml += `<option value="${op}" ${op===data.op?'selected':''}>${op}</option>`);
    }

    // HTML êµ¬ì¡° ìƒì„±
    // ìœ ë‹ˆí¬ ID ìƒì„±ì„ ìœ„í•´ í˜„ì¬ ì‹œê°„+ë‚œìˆ˜ ì‚¬ìš© (ìë™ì™„ì„± ì—°ê²°ìš©)
    const uid = Date.now() + Math.random().toString(36).substr(2, 5);
    const varInputId = `${type}-var-${uid}`;
    const listId = `${type}-list-${uid}`;

    div.innerHTML = `
        <div style="position: relative; flex: 1;">
            <input type="text" class="logic-var" id="${varInputId}" value="${data.variable}" placeholder="ë³€ìˆ˜ëª…" autocomplete="off">
            <ul id="${listId}" class="autocomplete-list"></ul>
        </div>
        <select class="logic-op" style="width: 60px;">${opsHtml}</select>
        <input type="text" class="logic-val" value="${data.value}" placeholder="ê°’" style="flex: 1;">
        <button class="btn-del-logic" onclick="this.parentElement.remove(); updateNodeDataFromBuilder('${type}')">x</button>
    `;

    container.appendChild(div);

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²°
    const varInput = div.querySelector('.logic-var');
    const opSelect = div.querySelector('.logic-op');
    const valInput = div.querySelector('.logic-val');

    // ì…ë ¥ ì‹œ ìë™ ì €ì¥ íŠ¸ë¦¬ê±°
    [varInput, opSelect, valInput].forEach(el => {
        el.addEventListener('input', () => updateNodeDataFromBuilder(type));
        el.addEventListener('change', () => updateNodeDataFromBuilder(type));
    });

    // ìë™ì™„ì„± ì—°ê²°
    setupAutocomplete(varInputId, listId);
}

// 2. UI ë³€ê²½ì‚¬í•­ì„ ë°ì´í„°(hidden input)ì— ë°˜ì˜ ë° ì €ì¥
function updateNodeDataFromBuilder(type) {
    const container = document.getElementById(`${type}-container`);
    const rows = container.querySelectorAll('.logic-row-item');
    let logicList = [];

    rows.forEach(row => {
        const v = row.querySelector('.logic-var').value.trim();
        const o = row.querySelector('.logic-op').value;
        const val = row.querySelector('.logic-val').value.trim();
        
        if (v && val) {
            logicList.push(`${v} ${o} ${val}`);
        }
    });

    // ê¸°ì¡´ í¬ë§· ìœ ì§€: ì¡°ê±´ì€ &&ë¡œ, ì—°ì‚°ì€ ;ë¡œ ì—°ê²°
    const separator = (type === 'req') ? ' && ' : '; ';
    const resultString = logicList.join(separator);

    document.getElementById(`input-${type}`).value = resultString;
    
    // ì‹¤ì œ ë…¸ë“œ ë°ì´í„° ì—…ë°ì´íŠ¸
    updateNodeData(); 
}

// 3. ì €ì¥ëœ ë¬¸ìì—´ì„ íŒŒì‹±í•˜ì—¬ UI ë¹Œë“œ (íŒ¨ë„ ì—´ ë•Œ í˜¸ì¶œ)
function buildLogicUI(str, type) {
    const container = document.getElementById(`${type}-container`);
    container.innerHTML = ''; // ì´ˆê¸°í™”

    if (!str || !str.trim()) return;

    // êµ¬ë¶„ìë¡œ ë¶„ë¦¬
    const separator = (type === 'req') ? '&&' : ';';
    const items = str.split(separator);

    items.forEach(item => {
        item = item.trim();
        if (!item) return;

        // ì •ê·œì‹ìœ¼ë¡œ ë³€ìˆ˜, ì—°ì‚°ì, ê°’ ë¶„ë¦¬
        // ì˜ˆ: "hp >= 10" -> ["hp", ">=", "10"]
        // ì§€ì›í•˜ëŠ” ì—°ì‚°ìë“¤ì„ ëª¨ë‘ í¬í•¨
        const match = item.match(/^(.+?)\s*(==|!=|>=|<=|>|<|\+=|-=|=)\s*(.+)$/);
        
        if (match) {
            addLogicRow(type, {
                variable: match[1].trim(),
                op: match[2].trim(),
                value: match[3].trim()
            });
        } else {
            // íŒŒì‹± ì‹¤íŒ¨ ì‹œ í†µì§¸ë¡œ ë³€ìˆ˜ëª…ì— ë„£ê±°ë‚˜ ë¬´ì‹œ (ì—¬ê¸°ì„  ì•ˆì „í•˜ê²Œ ë³€ìˆ˜ëª…ì— ë„£ì–´ë‘ )
            addLogicRow(type, { variable: item, op: '', value: '' });
        }
    });
}
        function updateSepData() { if(selectionType!=='separator'||selectedIds.size!==1)return; const s=separators.find(x=>x.id===Array.from(selectedIds)[0]); s.label=document.getElementById('input-sep-label').value; s.desc=document.getElementById('input-sep-desc').value; render(); }
        function createConnection(sourceId, targetId) {
            if (connections.some(c => c.from === sourceId && c.to === targetId)) {
                showToast("ì´ë¯¸ ì—°ê²°ë˜ì–´ ìˆìŠµë‹ˆë‹¤.");
                return;
            }
            connections.push({
                id: 'conn_' + Date.now(),
                from: sourceId,
                to: targetId
            });
            render();
            pushHistory();
            showToast("ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤");
        }
        function openPanel() {
    if (selectedIds.size !== 1) return;
    const id = Array.from(selectedIds)[0];
    const gn = document.getElementById('group-node');
    const gg = document.getElementById('group-group');

    if (selectionType === 'node') {
        gn.classList.add('visible');
        if(gg) gg.classList.remove('visible');
        
        const n = nodes.find(x => x.id === id);
        if(n) {
            updatePanelTypeSelector();

            document.getElementById('input-title').value = n.title;
            document.getElementById('input-type').value = n.type;
            document.getElementById('input-summary').value = n.summary || '';
    document.getElementById('input-summary').oninput = updateNodeDialogue; // ì´ë²¤íŠ¸ ì—°ê²°

    const diaContainer = document.getElementById('dialogue-container');
    diaContainer.innerHTML = '';
    
    if (n.dialogues && n.dialogues.length > 0) {
        n.dialogues.forEach(d => addDialogueRow(d));
    } else if (n.desc) {
        // [ë§ˆì´ê·¸ë ˆì´ì…˜] êµ¬ë²„ì „ ë°ì´í„°(desc)ê°€ ìˆìœ¼ë©´ ì§€ë¬¸ìœ¼ë¡œ ë³€í™˜
        addDialogueRow({ charId: '', text: n.desc });
    } else {
        // ë¹ˆ ë…¸ë“œë©´ ê¸°ë³¸ í•œ ì¤„ ì¶”ê°€
        addDialogueRow();
    }
            setTimeout(() => {
        document.querySelectorAll('#dialogue-container textarea').forEach(el => autoResize(el));
    }, 10);
            // hidden inputì— ê°’ ì„¸íŒ…
            document.getElementById('input-req').value = n.req || '';
            document.getElementById('input-act').value = n.act || '';

            // [ì¤‘ìš”] ë¬¸ìì—´ íŒŒì‹±í•˜ì—¬ ë¹„ì£¼ì–¼ ë¹Œë” ìƒì„±
            buildLogicUI(n.req || '', 'req');
            buildLogicUI(n.act || '', 'act');
        }
    } 
    else if (selectionType === 'group') {
                gn.classList.remove('visible');
                if(gg) gg.classList.add('visible');
                
                const g = groups.find(x => x.id === id);
                if (g) {
                    const tInput = document.getElementById('input-group-title');
                    const cInput = document.getElementById('input-group-color');
                    
                    if(tInput) tInput.value = g.title;
                    if(cInput) cInput.value = g.color || '#00f0ff';
                }
            }
            panel.classList.add('active'); 
        }
        
        function closePanel() {
            document.getElementById('detail-panel').classList.remove('active');
            document.activeElement.blur();
            selectedIds.clear();
            selectionType = null;
            connectSourceId = null; 
            render();
        }

        /* --- Play Mode Logic --- */
        let gameVars = {}; 
        let currentPlayNodeId = null;

        function startPlayMode() {
    // ì‹œì‘ ë…¸ë“œ ì°¾ê¸°
    let startNode = null;
    if (selectedIds.size === 1) startNode = nodes.find(n => n.id === Array.from(selectedIds)[0]);
    if (!startNode) startNode = nodes.find(n => n.title.toLowerCase() === 'start') || nodes[0];
    if (!startNode) return showToast("ë…¸ë“œê°€ ì—†ìŠµë‹ˆë‹¤.");

    // ë³€ìˆ˜ ì´ˆê¸°í™”
    gameVars = {};
    globalVars.forEach(v => {
        // ... ë³€ìˆ˜ ë¡œë“œ ë¡œì§ (ê¸°ì¡´ ë™ì¼) ...
        let val = v.value;
        if (v.type === 'number') val = parseFloat(v.value) || 0;
        if (v.type === 'boolean') val = (String(v.value).toLowerCase() === 'true');
        gameVars[v.name] = val;
    });

    document.getElementById('screen-play').style.display = 'flex';
    loadPlayNode(startNode.id);
}

function loadPlayNode(nodeId) {
    const node = nodes.find(n => n.id === nodeId);
    if (!node) return;

    playState.currentNode = node;
    playState.dialogueIndex = 0;
    playState.isWaitingChoice = false;

    const labelEl = document.getElementById('vn-scene-label');
    if (labelEl) {
        labelEl.textContent = `ğŸ“ ${node.title}`;
        // (ì„ íƒì‚¬í•­) ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼ë¡œ ê°•ì¡°
        labelEl.style.opacity = '0';
        setTimeout(() => labelEl.style.opacity = '1', 100);
    }

    // ë…¸ë“œ ì§„ì… ì‹œ SET ì•¡ì…˜ ì‹¤í–‰
    if (node.act) executeAction(node.act);

    // ëŒ€ì‚¬ê°€ ì—†ìœ¼ë©´ ë°”ë¡œ ì„ íƒì§€/ì¢…ë£Œ ì²˜ë¦¬
    if (!node.dialogues || node.dialogues.length === 0) {
        // êµ¬ë²„ì „ í˜¸í™˜ (descê°€ ìˆë‹¤ë©´)
        if (node.desc) {
            node.dialogues = [{ charId: '', text: node.desc }];
        } else {
            showChoicesOrNext();
            return;
        }
    }

    // ì²« ëŒ€ì‚¬ ì¶œë ¥
    renderCurrentDialogue();
}

function renderCurrentDialogue() {
    const node = playState.currentNode;
    const line = node.dialogues[playState.dialogueIndex];
    
    const nameBox = document.getElementById('vn-namebox');
    const textBox = document.getElementById('vn-text');
    const indicator = document.getElementById('vn-indicator');
    
    // UI ì´ˆê¸°í™”
    document.getElementById('vn-choices').innerHTML = ''; // ì„ íƒì§€ ìˆ¨ê¹€
    document.getElementById('vn-textbox').style.display = 'block'; // ëŒ€í™”ì°½ ë³´ì„
    indicator.style.display = 'block'; // ì§„í–‰ ì•„ì´ì½˜ ë³´ì„

    // ìºë¦­í„° ì •ë³´ ì°¾ê¸°
    const charData = characters.find(c => c.id === line.charId);
    
    if (charData) {
        nameBox.textContent = charData.name;
        nameBox.style.display = 'block';
        nameBox.style.color = charData.color;
        nameBox.style.borderColor = charData.color;
    } else {
        nameBox.style.display = 'none'; // ì§€ë¬¸(Narration)
    }

    textBox.innerHTML = line.text.replace(/\n/g, '<br>');
}

function advanceGameStep() {
    if (playState.isWaitingChoice) return; // ì„ íƒì§€ ëŒ€ê¸° ì¤‘ì—” í´ë¦­ ë¬´ì‹œ

    const node = playState.currentNode;
    playState.dialogueIndex++;

    if (playState.dialogueIndex < node.dialogues.length) {
        // ë‹¤ìŒ ëŒ€ì‚¬ ì¶œë ¥
        renderCurrentDialogue();
    } else {
        // ëŒ€ì‚¬ ë -> ì„ íƒì§€ í‘œì‹œ ë˜ëŠ” ë‹¤ìŒ ë…¸ë“œ ìë™ ì´ë™
        showChoicesOrNext();
    }
}

function showChoicesOrNext() {
    const node = playState.currentNode;
    const outgoing = connections.filter(c => c.from === node.id);
    
    const choiceContainer = document.getElementById('vn-choices');
    const textBox = document.getElementById('vn-textbox');
    
    // ëŒ€í™”ì°½ ìˆ¨ê¸°ê¸° (ì„ íƒì§€ ì§‘ì¤‘) ë˜ëŠ” ë‚¨ê²¨ë‘ê¸° ì·¨í–¥ ì°¨ì´. ì—¬ê¸°ì„  ìˆ¨ê¹€.
    textBox.style.display = 'none';

    if (outgoing.length === 0) {
        // ì—”ë”©
        const endBtn = document.createElement('div');
        endBtn.className = 'vn-choice-btn';
        endBtn.innerHTML = node.type === 'dead' ? "â˜ ï¸ BAD END â˜ ï¸" : "â˜… THE END â˜…";
        endBtn.onclick = () => startPlayMode(); // ì¬ì‹œì‘
        choiceContainer.appendChild(endBtn);
        playState.isWaitingChoice = true;
        return;
    }

    // ìœ íš¨í•œ ì„ íƒì§€ í•„í„°ë§
    const validLinks = outgoing.filter(conn => {
        const target = nodes.find(n => n.id === conn.to);
        if (!target) return false;
        if (target.req) return checkRequirement(target.req);
        return true;
    });

    if (validLinks.length === 0) {
        // ê°ˆ ê³³ ì—†ìŒ
        const btn = document.createElement('div');
        btn.className = 'vn-choice-btn';
        btn.textContent = "ì§„í–‰ ë¶ˆê°€ (ì¡°ê±´ ë¶ˆì¶©ì¡±)";
        choiceContainer.appendChild(btn);
        playState.isWaitingChoice = true;
        return;
    }

    if (validLinks.length === 1 && node.type !== 'choice') {
        // ì„ íƒì§€ê°€ ì•„ë‹Œ ì¼ë°˜ ì—°ê²°ì´ë©´ ìë™ ì§„í–‰
        loadPlayNode(validLinks[0].to);
    } else {
        // ì„ íƒì§€ ë²„íŠ¼ ìƒì„±
        validLinks.forEach(conn => {
            const target = nodes.find(n => n.id === conn.to);
            const btn = document.createElement('div');
            btn.className = 'vn-choice-btn';
            btn.textContent = target.title; // í˜¹ì€ target.summary
            btn.onclick = (e) => {
                e.stopPropagation();
                loadPlayNode(target.id);
            };
            choiceContainer.appendChild(btn);
        });
        playState.isWaitingChoice = true;
    }
}

        function closePlayMode() {
            document.getElementById('screen-play').style.display = 'none';
        }

        function goToPlayNode(nodeId) {
            const node = nodes.find(n => n.id === nodeId);
            if (!node) return;
            currentPlayNodeId = nodeId;
            if (node.act) {
                executeAction(node.act);
                updateDebugView();
            }
            const textEl = document.getElementById('play-text');
            let displayHTML = `<strong style="color:var(--accent-cyan)">[${node.title}]</strong><br><br>`;
            displayHTML += node.desc.replace(/\n/g, "<br>");
            textEl.innerHTML = displayHTML;
            renderPlayChoices(node);
        }

        function renderPlayChoices(currentNode) {
            const container = document.getElementById('play-choices');
            container.innerHTML = '';
            const outgoing = connections.filter(c => c.from === currentNode.id);
            if (outgoing.length === 0) {
                createSystemMessage(container, currentNode.type === 'dead' ? "BAD END" : "THE END", true);
                return;
            }
            let validChoiceCount = 0;
            outgoing.forEach(conn => {
                const targetNode = nodes.find(n => n.id === conn.to);
                if (!targetNode) return;
                if (targetNode.req) {
                    const passed = checkRequirement(targetNode.req);
                    if (!passed) return; 
                }
                validChoiceCount++;
                const btn = document.createElement('button');
                btn.className = 'play-btn';
                btn.textContent = targetNode.title; 
                btn.onclick = () => goToPlayNode(targetNode.id);
                if (targetNode.type === 'dead') btn.classList.add('dead-end');
                container.appendChild(btn);
            });
            if (validChoiceCount === 0) {
                createSystemMessage(container, "ğŸš« ì¡°ê±´ì— ë§ëŠ” ë‹¤ìŒ ì§„í–‰ ë£¨íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.", true);
            }
        }

        function createSystemMessage(container, text, isRestart) {
            const btn = document.createElement('div');
            btn.className = 'play-btn';
            btn.style.borderColor = '#555';
            btn.style.color = '#aaa';
            btn.style.textAlign = 'center';
            btn.style.cursor = isRestart ? 'pointer' : 'default';
            btn.textContent = text + (isRestart ? " (í´ë¦­í•˜ì—¬ ì²˜ìŒìœ¼ë¡œ)" : "");
            if(isRestart) {
                btn.onclick = () => startPlayMode();
            }
            container.appendChild(btn);
        }

        function executeAction(script) {
            if (!script || !script.trim()) return;
            const commands = script.split(';');
            commands.forEach(cmd => {
                cmd = cmd.trim();
                if (!cmd) return;
                const match = cmd.match(/^([a-zA-Z0-9_]+)\s*(\+=|-=|=)\s*(.+)$/);
                if (match) {
                    const key = match[1];
                    const op = match[2];
                    let valStr = match[3];
                    let val;
                    if (valStr === 'true') val = true;
                    else if (valStr === 'false') val = false;
                    else if (!isNaN(parseFloat(valStr))) val = parseFloat(valStr);
                    else val = valStr.replace(/['"]/g, '');
                    let current = gameVars[key];
                    if (current === undefined || current === null) {
                        current = (typeof val === 'number') ? 0 : '';
                    }
                    if (op === '=') {
                        gameVars[key] = val;
                    } else if (op === '+=') {
                        gameVars[key] = current + val;
                    } else if (op === '-=') {
                        gameVars[key] = current - val;
                    }
                }
            });
        }

        function checkRequirement(script) {
            if (!script || !script.trim()) return true; 
            const conditions = script.split('&&');
            for (let cond of conditions) {
                cond = cond.trim();
                if (!cond) continue;
                const match = cond.match(/^([a-zA-Z0-9_]+)\s*(==|!=|>=|<=|>|<)\s*(.+)$/);
                if (match) {
                    const key = match[1];
                    const op = match[2];
                    let targetVal = match[3];
                    if (targetVal === 'true') targetVal = true;
                    else if (targetVal === 'false') targetVal = false;
                    else if (!isNaN(parseFloat(targetVal))) targetVal = parseFloat(targetVal);
                    else targetVal = targetVal.replace(/['"]/g, '');
                    const currentVal = (gameVars[key] !== undefined) ? gameVars[key] : 0;
                    let result = false;
                    if (op === '==') result = (currentVal == targetVal);
                    else if (op === '!=') result = (currentVal != targetVal);
                    else if (op === '>=') result = (currentVal >= targetVal);
                    else if (op === '<=') result = (currentVal <= targetVal);
                    else if (op === '>') result = (currentVal > targetVal);
                    else if (op === '<') result = (currentVal < targetVal);
                    if (!result) return false; 
                } else {
                    if (!gameVars[cond]) return false;
                }
            }
            return true; 
        }

        function updateDebugView() {
            const el = document.getElementById('debug-vars');
            if (Object.keys(gameVars).length === 0) {
                el.textContent = "No variables";
                return;
            }
            let html = '';
            for (const [k, v] of Object.entries(gameVars)) {
                html += `<div><span style="color:#aaa">${k}:</span> <b>${v}</b></div>`;
            }
            el.innerHTML = html;
        }

        window.updateGroupData = function() {
            // ë””ë²„ê¹…ìš© ë¡œê·¸ (F12 ì½˜ì†”ì—ì„œ í™•ì¸ ê°€ëŠ¥)
            // console.log("updateGroupData called", selectionType, selectedIds);

            if (selectionType !== 'group' || selectedIds.size !== 1) return;
            
            const id = Array.from(selectedIds)[0];
            const g = groups.find(x => x.id === id);
            if (!g) return;

            const tInput = document.getElementById('input-group-title');
            const cInput = document.getElementById('input-group-color');

            if (tInput) g.title = tInput.value;
            if (cInput) g.color = cInput.value;
            
            // ë°ì´í„°ê°€ ë³€ê²½ë˜ì—ˆìœ¼ë‹ˆ í™”ë©´ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
            render(); 
        };

        window.resetGroupColor = function() {
            const cInput = document.getElementById('input-group-color');
            if (cInput) {
                cInput.value = '#00f0ff';
                window.updateGroupData();
            }
        };

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && document.getElementById('screen-play').style.display === 'flex') {
                closePlayMode();
            }
        });

function openExportImageModal() {
            document.getElementById('export-image-modal').style.display = 'flex';
        }

        function exportImageAction(mode) {
            document.getElementById('export-image-modal').style.display = 'none';
            
            if (mode === 'selected' && selectedIds.size === 0) {
                showToast("ì„ íƒëœ ìš”ì†Œê°€ ì—†ìŠµë‹ˆë‹¤. ì „ì²´ë¥¼ ì €ì¥í•©ë‹ˆë‹¤.");
                mode = 'all';
            }

            showToast("ğŸ“· ì´ë¯¸ì§€ ìƒì„± ì¤‘...");

            // 1. í˜„ì¬ ì„ íƒ ìƒíƒœ ë°±ì—…
            const savedSelectedIds = new Set(selectedIds);
            const savedSelectionType = selectionType;

            // 2. ìº¡ì²˜ ëŒ€ìƒì„ í™•ì • (ì„ íƒëœ ë…¸ë“œ/ê·¸ë£¹ + ê·¸ ì•ˆì˜ ë…¸ë“œë“¤)
            const targetNodeIds = new Set();
            const targetGroupIds = new Set();

            if (mode === 'all') {
                nodes.forEach(n => targetNodeIds.add(n.id));
                groups.forEach(g => targetGroupIds.add(g.id));
            } else {
                // ë¨¼ì € ì§ì ‘ ì„ íƒëœ ê²ƒë“¤ ì¶”ê°€
                selectedIds.forEach(id => {
                    if (nodes.find(n => n.id === id)) targetNodeIds.add(id);
                    if (groups.find(g => g.id === id)) targetGroupIds.add(id);
                });

                // ì„ íƒëœ ê·¸ë£¹ ì•ˆì— í¬í•¨ëœ ë…¸ë“œë“¤ë„ ìë™ìœ¼ë¡œ ì¶”ê°€
                groups.forEach(g => {
                    if (targetGroupIds.has(g.id)) {
                        nodes.forEach(n => {
                            // ê·¸ë£¹ ë²”ìœ„ ì•ˆì— ë…¸ë“œ ì¤‘ì‹¬ì´ ìˆëŠ”ì§€ í™•ì¸
                            const nx = n.x + NODE_W/2;
                            const ny = n.y + NODE_H/2;
                            if (nx >= g.x && nx <= g.x + g.w && ny >= g.y && ny <= g.y + g.h) {
                                targetNodeIds.add(n.id);
                            }
                        });
                    }
                });
            }

            // 3. [í•µì‹¬] í™”ë©´ìƒì—ì„œ ì„ íƒ í•´ì œ (ë©”ë‰´, í…Œë‘ë¦¬ ì œê±°)
            selectedIds.clear();
            selectionType = null;
            render(); 

            // 4. ìº¡ì²˜ ì˜ì—­(Bounding Box) ì¬ê³„ì‚°
            let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
            let hasItems = false;

            nodes.forEach(n => {
                if (targetNodeIds.has(n.id)) {
                    hasItems = true;
                    minX = Math.min(minX, n.x);
                    minY = Math.min(minY, n.y);
                    maxX = Math.max(maxX, n.x + NODE_W);
                    maxY = Math.max(maxY, n.y + NODE_H);
                }
            });
            groups.forEach(g => {
                if (targetGroupIds.has(g.id)) {
                    hasItems = true;
                    minX = Math.min(minX, g.x);
                    minY = Math.min(minY, g.y);
                    maxX = Math.max(maxX, g.x + g.w);
                    maxY = Math.max(maxY, g.y + g.h);
                }
            });

            if (!hasItems) {
                // ë³µêµ¬ í›„ ì¢…ë£Œ
                selectedIds = savedSelectedIds;
                selectionType = savedSelectionType;
                render();
                showToast("ì¶œë ¥í•  ëŒ€ìƒì´ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            const padding = 50;
            const width = (maxX - minX) + (padding * 2);
            const height = (maxY - minY) + (padding * 2);

            // 5. ì´ë¯¸ì§€ ìƒì„± ì‹¤í–‰
            const element = document.getElementById('world-container');
            
            htmlToImage.toPng(element, {
                backgroundColor: '#050510',
                width: width,
                height: height,
                style: {
                    transform: `translate(${-minX + padding}px, ${-minY + padding}px) scale(1)`,
                    transformOrigin: 'top left'
                },
                filter: (domNode) => {
                    // UI ìš”ì†Œ ì œì™¸
                    if (domNode.id === 'selection-box' || domNode.id === 'temp-link') return false;
                    
                    // ë…¸ë“œ í•„í„°ë§
                    if (domNode.classList && domNode.classList.contains('node')) {
                        return targetNodeIds.has(domNode.id);
                    }
                    // ê·¸ë£¹ í•„í„°ë§
                    if (domNode.classList && domNode.classList.contains('group-box')) {
                        return targetGroupIds.has(domNode.id);
                    }
                    // ì—°ê²°ì„  í•„í„°ë§
                    if (domNode.tagName === 'path' && (domNode.classList.contains('link') || domNode.classList.contains('link-hit'))) {
                        const connId = domNode.dataset.id;
                        if (!connId) return true; 
                        const conn = connections.find(c => c.id === connId);
                        if (!conn) return false;
                        // ì–‘ìª½ ë…¸ë“œê°€ ëª¨ë‘ ì¶œë ¥ ëŒ€ìƒì¼ ë•Œë§Œ ì„ ë„ ì¶œë ¥
                        return targetNodeIds.has(conn.from) && targetNodeIds.has(conn.to);
                    }
                    return true;
                }
            })
            .then(function (dataUrl) {
                const link = document.createElement('a');
                link.download = `flowchart_${mode}_${Date.now()}.png`;
                link.href = dataUrl;
                link.click();
                showToast("âœ… ì´ë¯¸ì§€ ì €ì¥ ì™„ë£Œ!");
                
                // [ë³µêµ¬] ì›ë˜ ì„ íƒ ìƒíƒœë¡œ ë˜ëŒë¦¬ê¸°
                selectedIds = savedSelectedIds;
                selectionType = savedSelectionType;
                render();
            })
            .catch(function (error) {
                console.error('Export Error:', error);
                showToast("âŒ ì´ë¯¸ì§€ ì €ì¥ ì‹¤íŒ¨");
                
                // [ë³µêµ¬] ì‹¤íŒ¨ ì‹œì—ë„ ë³µêµ¬
                selectedIds = savedSelectedIds;
                selectionType = savedSelectionType;
                render();
            });
        }

        function exportRenPyScript() {
        let script = "# Generated by Blue Glass Flowchart\n\n";
        
        script += "# --- Global Variables ---\n";
    globalVars.forEach(v => {
        let val = v.value;
        if(v.type === 'string') val = `"${val}"`; // ë¬¸ìì—´ ë”°ì˜´í‘œ ì²˜ë¦¬
        if(v.type === 'boolean') val = (String(val).toLowerCase() === 'true') ? "True" : "False"; // Python Bool
        script += `default ${v.name} = ${val}\n`;
    });
    script += "\n";

        // ë³€ìˆ˜ ì´ˆê¸°í™” ë¸”ë¡
        script += "label start:\n";
        let startNode = nodes.find(n => n.title.toLowerCase() === 'start') || nodes[0];
        if(startNode) {
            script += `    jump ${sanitizeID(startNode.id)}\n\n`;
        } else {
            script += "    return\n\n";
        }

        nodes.forEach(node => {
            script += `# [Node: ${node.title}]\n`;
            script += `label ${sanitizeID(node.id)}:\n`;

            // 1) SET ë¡œì§ ($ ë³€ìˆ˜ = ê°’)
            if (node.act) {
                script += `    $ ${fixRenPySyntax(node.act)}\n`;
            }

            // 2) ë³¸ë¬¸ í…ìŠ¤íŠ¸
            if (node.desc) {
                const lines = node.desc.split('\n');
                lines.forEach(line => {
                    if(line.trim()) script += `    "${line.trim()}"\n`;
                });
            }

            // 3) ì—°ê²°ì„  ì²˜ë¦¬
            const outgoing = connections.filter(c => c.from === node.id);
            
            if (outgoing.length === 0) {
                // ì—°ê²° ì—†ìŒ -> ì—”ë”©
                if (node.type === 'dead') script += "    \"BAD ENDING\"\n    return\n\n";
                else script += "    return\n\n";
            } 
            else if (node.type === 'choice') {
                // ì„ íƒì§€ ë…¸ë“œ ì²˜ë¦¬
                script += "    menu:\n";
                outgoing.forEach(conn => {
                    const target = nodes.find(n => n.id === conn.to);
                    if(target) {
                        const rawReq = target.req ? fixRenPySyntax(target.req) : "";
                        const condition = rawReq ? ` if ${rawReq}` : "";
                        script += `        "${target.title}"${condition}:\n`;
                        script += `            jump ${sanitizeID(target.id)}\n`;
                    }
                });
                // [ì¤‘ìš”] ëª¨ë“  ì¡°ê±´ì´ Falseë¼ì„œ ë©”ë‰´ê°€ ìŠ¤í‚µë  ê²½ìš°ë¥¼ ëŒ€ë¹„í•œ ì•ˆì „ì¥ì¹˜
                script += "\n    # Fallback (ì¡°ê±´ ë¶ˆì¶©ì¡± ì‹œ ì‹¤í–‰)\n";
                script += "    \"ì¡°ê±´ì— ë§ëŠ” ì§„í–‰ ê²½ë¡œê°€ ì—†ìŠµë‹ˆë‹¤.\"\n";
                script += "    return\n\n";
            } 
            else {
                // ì¼ë°˜ ë…¸ë“œ ì²˜ë¦¬
                if (outgoing.length === 1) {
                    // ê°ˆë¦¼ê¸¸ì´ ì—†ìœ¼ë©´ ë°”ë¡œ ì í”„
                    const target = nodes.find(n => n.id === outgoing[0].to);
                    script += `    jump ${sanitizeID(target.id)}\n\n`;
                } else {
                    // ì¼ë°˜ ë…¸ë“œì—ì„œ ê°ˆë¦¼ê¸¸ì´ ìƒê¸°ë©´ ë©”ë‰´ë¡œ ë³€í™˜
                    script += "    menu:\n";
                    outgoing.forEach(conn => {
                        const target = nodes.find(n => n.id === conn.to);
                        const rawReq = target.req ? fixRenPySyntax(target.req) : "";
                        const condition = rawReq ? ` if ${rawReq}` : "";
                        script += `        "${target.title}"${condition}:\n`;
                        script += `            jump ${sanitizeID(target.id)}\n`;
                    });
                    // [ì¤‘ìš”] ì•ˆì „ì¥ì¹˜ ì¶”ê°€
                    script += "\n    # Fallback (ì¡°ê±´ ë¶ˆì¶©ì¡± ì‹œ ì‹¤í–‰)\n";
                    script += "    \"ì¡°ê±´ì— ë§ëŠ” ì§„í–‰ ê²½ë¡œê°€ ì—†ìŠµë‹ˆë‹¤.\"\n";
                    script += "    return\n\n";
                }
            }
        });

        downloadFile(`script_${Date.now()}.rpy`, script);
        showToast("ğŸ Ren'Py ìŠ¤í¬ë¦½íŠ¸ ì €ì¥ë¨");
        document.getElementById('export-modal').style.display='none';
    }

    // 2. Unity/Generic JSON ë‚´ë³´ë‚´ê¸°
    function exportUnityJSON() {
        // ëŸ°íƒ€ì„ì— í•„ìš”í•œ ë°ì´í„°ë§Œ ì •ì œ (ì¢Œí‘œ ì •ë³´ ì œì™¸)
        const exportData = {
            project: document.getElementById('current-project-name').textContent,
            version: "1.0",
            scenes: nodes.map(n => {
                // ì—°ê²°ëœ ë‹¤ìŒ ë…¸ë“œë“¤ì˜ ID ëª©ë¡
                const nextNodes = connections
                    .filter(c => c.from === n.id)
                    .map(c => {
                        const target = nodes.find(tn => tn.id === c.to);
                        return {
                            targetId: target.id,
                            targetTitle: target.title, // ë²„íŠ¼ í…ìŠ¤íŠ¸ìš©
                            condition: target.req || null
                        };
                    });

                return {
                    id: n.id,
                    title: n.title,
                    type: n.type,
                    text: n.desc,
                    onEnter: n.act || null, // ì§„ì… ì‹œ ì‹¤í–‰í•  ë¡œì§
                    next: nextNodes
                };
            })
        };

        const jsonStr = JSON.stringify(exportData, null, 2);
        downloadFile(`game_data_${Date.now()}.json`, jsonStr);
        showToast("ğŸ® ê²Œì„ ë°ì´í„° JSON ì €ì¥ë¨");
        document.getElementById('export-modal').style.display='none';
    }

    // ìœ í‹¸ë¦¬í‹°: íŒŒì¼ ë‹¤ìš´ë¡œë“œ
    function downloadFile(filename, content) {
        const element = document.createElement('a');
        element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(content));
        element.setAttribute('download', filename);
        element.style.display = 'none';
        document.body.appendChild(element);
        element.click();
        document.body.removeChild(element);
    }

    // ìœ í‹¸ë¦¬í‹°: ID ì •ì œ (Ren'Py ë¼ë²¨ëª… ê·œì¹™ í˜¸í™˜)
    function sanitizeID(id) {
        // ê³µë°±ì´ë‚˜ íŠ¹ìˆ˜ë¬¸ìê°€ ìˆìœ¼ë©´ ì•ˆë¨. IDëŠ” ì´ë¯¸ ì•ˆì „í•˜ì§€ë§Œ í˜¹ì‹œ ëª¨ë¥´ë‹ˆ ì²˜ë¦¬.
        return id.replace(/[^a-zA-Z0-9_]/g, '_');
    }

    function fixRenPySyntax(str) {
        if (!str) return "";
        // ë‹¨ì–´ ê²½ê³„(\b)ë¥¼ ì‚¬ìš©í•˜ì—¬ ë³€ìˆ˜ëª…(true_love ë“±)ì€ ê±´ë“œë¦¬ì§€ ì•Šê³  ê°’ë§Œ ë³€ê²½
        return str
            .replace(/\btrue\b/g, "True")
            .replace(/\bfalse\b/g, "False");
    }

    function openTypeManager() {
            const list = document.getElementById('type-list');
            list.innerHTML = '';
            
            nodeTypes.forEach((t, idx) => {
                const item = document.createElement('div');
                item.style.cssText = "display: flex; gap: 5px; align-items: center; background: rgba(255,255,255,0.05); padding: 5px; border-radius: 4px;";
                
                // ê¸°ë³¸ íƒ€ì…(normal, choice, dead)ì€ ID ìˆ˜ì • ë¶ˆê°€, ì‚­ì œ ë¶ˆê°€ë¡œ ì„¤ì • ê°€ëŠ¥í•˜ì§€ë§Œ
                // ì—¬ê¸°ì„œëŠ” ììœ ë¡­ê²Œ ìˆ˜ì • ê°€ëŠ¥í•˜ê²Œ í•˜ë˜ IDë§Œ ìœ ì§€ ê¶Œì¥
                
                item.innerHTML = `
                    <input type="color" value="${t.color}" onchange="updateType(${idx}, 'color', this.value)" style="width: 30px; height: 30px; border: none; padding: 0;">
                    <input type="text" value="${t.name}" oninput="updateType(${idx}, 'name', this.value)" style="flex: 1; background: transparent; border: 1px solid #555; color: #fff; padding: 4px;">
                    <button class="btn-danger" onclick="deleteType(${idx})" style="padding: 4px 8px;">ğŸ—‘ï¸</button>
                `;
                list.appendChild(item);
            });
            
            document.getElementById('type-manager-modal').style.display = 'flex';
        }

        function closeTypeManager() {
            document.getElementById('type-manager-modal').style.display = 'none';
            saveMetaData(); // ë³€ê²½ì‚¬í•­ ì €ì¥
            render(); // í™”ë©´ ê°±ì‹  (ìƒ‰ìƒ ë°˜ì˜)
            updatePanelTypeSelector(); // íŒ¨ë„ì˜ ì„ íƒë°•ìŠ¤ ê°±ì‹ 
        }

        function addNodeType() {
            const id = 'custom_' + Date.now();
            nodeTypes.push({ id: id, name: 'ìƒˆ íƒ€ì…', color: '#ffffff' });
            openTypeManager(); // ëª©ë¡ ê°±ì‹ 
        }

        window.updateType = (idx, key, val) => {
            nodeTypes[idx][key] = val;
        }

        window.deleteType = (idx) => {
            if (nodeTypes.length <= 1) return alert("ìµœì†Œ 1ê°œì˜ íƒ€ì…ì€ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.");
            if (!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ íƒ€ì…ì„ ì‚¬ìš©í•˜ëŠ” ë…¸ë“œëŠ” ê¸°ë³¸ íƒ€ì…ìœ¼ë¡œ ë³€ê²½ë©ë‹ˆë‹¤.")) return;
            
            const deletedId = nodeTypes[idx].id;
            nodeTypes.splice(idx, 1);
            
            // ì‚­ì œëœ íƒ€ì…ì„ ì“°ëŠ” ë…¸ë“œë“¤ì„ ì²« ë²ˆì§¸ íƒ€ì…ìœ¼ë¡œ ë³€ê²½
            const fallbackId = nodeTypes[0].id;
            nodes.forEach(n => {
                if(n.type === deletedId) n.type = fallbackId;
            });
            
            openTypeManager();
        }

        function updatePanelTypeSelector() {
            const select = document.getElementById('input-type');
            if (!select) return;
            const currentVal = select.value;
            select.innerHTML = '';
            
            nodeTypes.forEach(t => {
                const opt = document.createElement('option');
                opt.value = t.id;
                opt.textContent = t.name;
                select.appendChild(opt);
            });
            
            // ê°’ ìœ ì§€ ì‹œë„
            if (nodeTypes.some(t => t.id === currentVal)) {
                select.value = currentVal;
            }
        }

        function getCurrentNodeHeight() {
    // LOD ëª¨ë“œë©´ 34px(í—¤ë” í¬ê¸°), ì•„ë‹ˆë©´ NODE_H(90px) ë°˜í™˜
    return isLodMode ? 34 : NODE_H;
}

// --- Variable Manager Logic (ìˆ˜ì •ë¨) ---

function openVariableManager() {
    const list = document.getElementById('variable-list');
    list.innerHTML = '';
    
    globalVars.forEach((v, idx) => {
        const row = document.createElement('div');
        row.style.cssText = "display: grid; grid-template-columns: 2fr 1fr 1fr 40px; gap: 8px; align-items: center; padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.05);";
        
        // ê°’ ì…ë ¥ í•„ë“œ (Booleanì´ë©´ ë“œë¡­ë‹¤ìš´, ê·¸ ì™¸ì—” í…ìŠ¤íŠ¸)
        let valueInputHtml = '';
        if (v.type === 'boolean') {
            const isTrue = String(v.value).toLowerCase() === 'true';
            valueInputHtml = `
                <select onchange="updateVar(${idx}, 'value', this.value)" style="padding: 8px;">
                    <option value="false" ${!isTrue ? 'selected' : ''}>False</option>
                    <option value="true" ${isTrue ? 'selected' : ''}>True</option>
                </select>
            `;
        } else {
            valueInputHtml = `
                <input type="text" value="${v.value}" 
                       onchange="updateVar(${idx}, 'value', this.value)" 
                       placeholder="ê°’" style="padding: 8px;">
            `;
        }

        row.innerHTML = `
            <input type="text" value="${v.name}" onchange="updateVar(${idx}, 'name', this.value)" placeholder="ë³€ìˆ˜ëª…" style="padding: 8px;">
            
            <select onchange="updateVar(${idx}, 'type', this.value)" style="padding: 8px;">
                <option value="number" ${v.type==='number'?'selected':''}>Number</option>
                <option value="string" ${v.type==='string'?'selected':''}>String</option>
                <option value="boolean" ${v.type==='boolean'?'selected':''}>Boolean</option>
            </select>
            
            ${valueInputHtml}
            
            <button class="btn-danger" onclick="deleteVar(${idx})" style="padding: 0; font-size: 12px; height: 36px; display: flex; align-items: center; justify-content: center; width: 100%;">ğŸ—‘ï¸</button>
        `;
        list.appendChild(row);
    });
    
    document.getElementById('variable-manager-modal').style.display = 'flex';
}

function closeVariableManager() {
    // ìœ íš¨ì„± ê²€ì‚¬: ì´ë¦„ì´ ì—†ëŠ” ë³€ìˆ˜ ì œê±°
    globalVars = globalVars.filter(v => v.name.trim() !== "");
    document.getElementById('variable-manager-modal').style.display = 'none';
    
    // saveCurrentProject(); // ìë™ ì €ì¥
    
    // [ìˆ˜ì •] ì‚­ì œí•¨: updateDatalist(); (ì»¤ìŠ¤í…€ ìë™ì™„ì„±ì€ globalVarsë¥¼ ì§ì ‘ ì°¸ì¡°í•˜ë¯€ë¡œ ê°±ì‹  í˜¸ì¶œ ë¶ˆí•„ìš”)
}

function addVariable() {
    globalVars.push({ name: 'new_var', type: 'number', value: 0 });
    openVariableManager();
}

window.updateVar = (idx, key, val) => {
    if (key === 'type') {
        globalVars[idx].type = val;
        // íƒ€ì… ë³€ê²½ ì‹œ ì´ˆê¸°ê°’ ë¦¬ì…‹
        if (val === 'number') globalVars[idx].value = 0;
        else if (val === 'boolean') globalVars[idx].value = 'false';
        else if (val === 'string') globalVars[idx].value = '';
        openVariableManager(); // UI ê°±ì‹ 
        return;
    }
    globalVars[idx][key] = val;
}

window.deleteVar = (idx) => {
    openCustomModal("ì´ ë³€ìˆ˜ë¥¼ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?", [
        {
            text: "ì‚­ì œ",
            class: "btn btn-danger",
            action: () => {
                globalVars.splice(idx, 1);
                openVariableManager();
                closeModal();
            }
        },
        { 
            text: "ì·¨ì†Œ", 
            class: "btn", 
            action: closeModal 
        }
    ]);
}

// --- ì»¤ìŠ¤í…€ ìë™ì™„ì„±(Autocomplete) ë¡œì§ ---

function setupAutocomplete(inputId, listId) {
    const input = document.getElementById(inputId);
    const list = document.getElementById(listId);
    let currentFocus = -1;

    if(!input || !list) return;

    // 1. ì…ë ¥ ê°ì§€
    input.addEventListener('input', function(e) {
        const val = this.value;
        closeAllLists();
        if (!val) return false;
        
        currentFocus = -1;
        
        const matches = globalVars.filter(v => v.name.toLowerCase().includes(val.toLowerCase()));
        
        if (matches.length === 0) return;

        list.classList.add('active');

        matches.forEach(v => {
            const item = document.createElement('li');
            item.className = 'autocomplete-item';
            const regex = new RegExp(`(${val})`, "gi");
            const nameHtml = v.name.replace(regex, "<strong>$1</strong>");
            
            item.innerHTML = `<span>${nameHtml}</span> <span class="var-type-tag">${v.type}</span>`;
            
            item.addEventListener('click', function() {
                input.value = v.name;
                closeAllLists();
                updateNodeData(); // ê°’ ë³€ê²½ í›„ ì €ì¥ íŠ¸ë¦¬ê±°
            });
            
            list.appendChild(item);
        });
    });

    // 2. í‚¤ë³´ë“œ íƒìƒ‰
    input.addEventListener('keydown', function(e) {
        const items = list.getElementsByTagName('li');
        if (!list.classList.contains('active')) return;

        if (e.key === 'ArrowDown') {
            currentFocus++;
            addActive(items);
        } else if (e.key === 'ArrowUp') {
            currentFocus--;
            addActive(items);
        } else if (e.key === 'Enter') {
            e.preventDefault();
            if (currentFocus > -1) {
                if (items[currentFocus]) items[currentFocus].click();
            } else if (items.length === 1) {
                 items[0].click();
            }
        } else if (e.key === 'Escape') {
            closeAllLists();
        }
    });

    function addActive(items) {
        if (!items) return false;
        removeActive(items);
        if (currentFocus >= items.length) currentFocus = 0;
        if (currentFocus < 0) currentFocus = (items.length - 1);
        items[currentFocus].classList.add('focused');
        items[currentFocus].scrollIntoView({ block: "nearest" });
    }

    function removeActive(items) {
        for (let i = 0; i < items.length; i++) {
            items[i].classList.remove('focused');
        }
    }
}

function closeAllLists(elmnt) {
    const lists = document.querySelectorAll('.autocomplete-list');
    lists.forEach(l => {
        l.innerHTML = '';
        l.classList.remove('active');
    });
}

// ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
document.addEventListener('click', function (e) {
    if (!e.target.closest('.logic-row')) {
        closeAllLists();
    }
});

// ì´ˆê¸°í™” ì¬ì‹¤í–‰ (DOMContentLoadedì— ë„£ì–´ë‘” ê²ƒê³¼ ë³„ê°œë¡œ ì•ˆì „ì¥ì¹˜)
setupAutocomplete('req-var', 'req-var-list');
setupAutocomplete('act-var', 'act-var-list');

// [ì‹ ê·œ] ìˆ¨ê²¨ì§„ ë…¸ë“œ ID ëª©ë¡ì„ ê³„ì‚°í•˜ëŠ” ì¤‘ì•™ í•¨ìˆ˜
function getHiddenNodeIds() {
    const hiddenSet = new Set();
    
    groups.forEach(g => {
        if (g.collapsed) {
            // [í•µì‹¬ ìˆ˜ì •] í˜„ì¬ ì´ ê·¸ë£¹ì´ 'ì´ë™ ë“œë˜ê·¸ ì¤‘'ì´ë¼ë©´?
            // ë‹¨ìˆœ ì¢Œí‘œ ì¶©ëŒ ê²€ì‚¬ë¥¼ í•˜ì§€ ì•Šê³ , ë“œë˜ê·¸ ì‹œì‘ ì‹œ ìºì‹±í•´ë‘” 'ì§„ì§œ ë‚´ë¶€ ë…¸ë“œ'ë§Œ ìˆ¨ê¹€ ì²˜ë¦¬í•©ë‹ˆë‹¤.
            // ì´ë¥¼ í†µí•´ ì´ë™ ì¤‘ ë‹¤ë¥¸ ë…¸ë“œ ìœ„ë¥¼ ì§€ë‚˜ê°ˆ ë•Œ ê·¸ ë…¸ë“œê°€ ì‚¬ë¼ì§€ëŠ”(í¡ìˆ˜ë˜ëŠ”) ë²„ê·¸ë¥¼ ë°©ì§€í•©ë‹ˆë‹¤.
            if (isDragging && dragType === 'group-move' && dragId === g.id && window.draggedGroupNodes) {
                window.draggedGroupNodes.forEach(nid => hiddenSet.add(nid));
            } 
            else {
                // ë“œë˜ê·¸ ì¤‘ì´ ì•„ë‹ ë•ŒëŠ” ì •ìƒì ìœ¼ë¡œ ì¢Œí‘œ ê¸°ë°˜ ê²€ì‚¬ ìˆ˜í–‰
                nodes.forEach(n => {
                    const cx = n.x + NODE_W/2;
                    const cy = n.y + NODE_H/2;
                    if (cx >= g.x && cx <= g.x + g.w &&
                        cy >= g.y && cy <= g.y + g.h) {
                        hiddenSet.add(n.id);
                    }
                });
            }
        }
    });
    return hiddenSet;
}

function openCharManager() {
    const list = document.getElementById('char-list');
    list.innerHTML = '';
    characters.forEach((c, idx) => {
        const row = document.createElement('div');
        row.className = 'char-row';
        row.innerHTML = `
            <input type="color" class="color-picker" value="${c.color}" onchange="updateChar(${idx}, 'color', this.value)">
            <input type="text" value="${c.name}" onchange="updateChar(${idx}, 'name', this.value)" style="flex: 1;">
            <button class="btn-danger" onclick="deleteChar(${idx})" style="padding: 4px 8px;">x</button>
        `;
        list.appendChild(row);
    });
    document.getElementById('char-manager-modal').style.display = 'flex';
}

function closeCharManager() {
    document.getElementById('char-manager-modal').style.display = 'none';
    saveCurrentProject();
}

function addCharacter() {
    characters.push({ id: 'char_'+Date.now(), name: 'ì´ë¦„', color: '#ffffff' });
    openCharManager();
}

function updateChar(idx, key, val) {
    characters[idx][key] = val;
}

function deleteChar(idx) {
    if(confirm("ìºë¦­í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
        characters.splice(idx, 1);
        openCharManager();
    }
}

// ëŒ€ì‚¬ í•œ ì¤„ ì¶”ê°€ (UI)
function addDialogueRow(data = { charId: '', text: '' }) {
    const container = document.getElementById('dialogue-container');
    const div = document.createElement('div');
    div.className = 'dialogue-row';
    
    // ìºë¦­í„° ì„ íƒ ì˜µì…˜
    let options = `<option value="">(ì§€ë¬¸)</option>`;
    characters.forEach(c => {
        options += `<option value="${c.id}" ${c.id === data.charId ? 'selected' : ''} style="color:${c.color}">${c.name}</option>`;
    });

    // Textarea ìƒì„± ë° ì´ë²¤íŠ¸ ì—°ê²°
    const textarea = document.createElement('textarea');
    textarea.className = 'dia-text';
    textarea.value = data.text;
    
    // [í•µì‹¬ ìˆ˜ì •] ì…ë ¥í•  ë•Œë§ˆë‹¤ ë†’ì´ ì¡°ì ˆ + ë°ì´í„° ì €ì¥ + ë Œë”ë§ ì‹¤í–‰
    textarea.oninput = function() {
        autoResize(this);       // ë†’ì´ ìë™ ì¡°ì ˆ
        updateNodeDialogue();   // ë°ì´í„° ì €ì¥ ë° ë…¸ë“œ í™”ë©´ ê°±ì‹  (render)
    };

    // ìºë¦­í„° ì„ íƒ ë³€ê²½ ì‹œì—ë„ ê°±ì‹  (ìƒ‰ìƒ ë  ì—…ë°ì´íŠ¸ìš©)
    const select = document.createElement('select');
    select.className = 'dia-char';
    select.innerHTML = options;
    select.onchange = updateNodeDialogue;

    // ì‚­ì œ ë²„íŠ¼
    const delBtn = document.createElement('button');
    delBtn.className = 'btn-danger';
    delBtn.style.cssText = "width:24px; height:32px; padding:0;";
    delBtn.textContent = 'x';
    delBtn.onclick = function() {
        div.remove();
        updateNodeDialogue(); // ì‚­ì œ í›„ ì¦‰ì‹œ ë°˜ì˜
    };

    div.appendChild(select);
    div.appendChild(textarea);
    div.appendChild(delBtn);
    
    container.appendChild(div);

    // ìƒì„± ì§í›„ ë†’ì´ ë§ì¶¤
    setTimeout(() => autoResize(textarea), 0);
}

// UI -> ë°ì´í„° ì €ì¥
function updateNodeDialogue() {
    if (selectedIds.size !== 1) return;
    const n = nodes.find(x => x.id === Array.from(selectedIds)[0]);
    
    // Summary ì €ì¥
    n.summary = document.getElementById('input-summary').value;

    // Dialogues ë°°ì—´ ìƒì„± ë° ì €ì¥
    const rows = document.querySelectorAll('.dialogue-row');
    const newDialogues = [];
    rows.forEach(row => {
        newDialogues.push({
            charId: row.querySelector('.dia-char').value,
            text: row.querySelector('.dia-text').value
        });
    });
    n.dialogues = newDialogues;
    
    render(); // ì°¨íŠ¸ ê°±ì‹  (Summary ë°˜ì˜)
}

function autoResize(el) {
    el.style.height = 'auto'; // ë†’ì´ ì´ˆê¸°í™”
    el.style.height = (el.scrollHeight) + 'px'; // ë‚´ìš©ë§Œí¼ ëŠ˜ë¦¬ê¸°
}



    </script>
</body>
</html>